<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScoreBoard v5</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#111827,#4f46e5);margin:0;padding:20px}
    .container{max-width:1160px;margin:auto;background:#fff;padding:22px 22px 28px;border-radius:18px;box-shadow:0 15px 40px rgba(0,0,0,.25);position:relative}
    h1{margin:6px 0 6px;text-align:center}
    .subh{margin:0 0 10px;text-align:center;color:#4b5563;font-size:13px}
    .top-right{position:absolute;top:14px;right:16px;display:flex;gap:10px;align-items:center}
    .link-btn{font-size:12px;color:#4f46e5;cursor:pointer;user-select:none;background:none;border:none}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin:6px 0}
    .section{margin-top:16px;padding:14px;border:1px solid #eef2ff;border-radius:14px;background:#fafbff}
    .section h3{margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{padding:10px;margin:6px 0;box-sizing:border-box;border-radius:10px;border:1px solid #d1d5db}
    input,select{width:100%}
    .row > *{flex:1 1 180px}
    button{background:#4f46e5;color:#fff;border:none;cursor:pointer;font-weight:900}
    button:hover{background:#4338ca}
    .ghost{background:#111827}
    .ghost:hover{background:#0b1220}
    .danger{background:#dc2626}
    .danger:hover{background:#b91c1c}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .muted{color:#6b7280;font-size:12px}
    .hidden{display:none !important}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .grid4{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width: 900px){.grid2,.grid4{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:12px}
    .card .t{font-weight:900;margin-bottom:4px}
    .card .d{font-size:13px;color:#374151}
    canvas{margin-top:10px}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap}
    .btnbar button{width:auto;padding:8px 12px;border-radius:999px}
    .btnbar .active{outline:3px solid #c7d2fe}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:center}
    th{background:#f3f4f6}
    .mini{font-size:12px}
    .hr{height:1px;background:#eef2ff;margin:12px 0}

    .tag{display:inline-block;font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;color:#111827}
    .tag.good{border-color:#bbf7d0}
    .tag.warn{border-color:#fde68a}
    .tag.bad{border-color:#fecaca}
    .tag.neutral{border-color:#c7d2fe}

    .footer{margin-top:16px;padding-top:12px;border-top:1px solid #eef2ff}
    .footer-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .footer small{color:#6b7280}
    .footer .mini-btn{background:#fff;border:1px solid #e5e7eb;color:#111827;font-weight:800}
    .footer .mini-btn:hover{background:#f3f4f6}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .modal{width:min(860px,100%);max-height:85vh;overflow:auto;background:#fff;border-radius:16px;border:1px solid #eee;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:16px}
    .modal h3{margin:4px 0 10px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .modal .actions button{width:auto;border-radius:999px;padding:8px 12px}
    details{background:#fff;border:1px solid #eee;border-radius:14px;padding:10px}
    details summary{cursor:pointer;font-weight:900}
    .logo-circle{width:36px;height:36px;border-radius:999px;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-weight:900;color:#3730a3;border:1px solid #c7d2fe}
    .card-row{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
  </style>
</head>

<body>
  <div class="container">
    <div class="top-right">
      <button id="manageTab" class="link-btn hidden" type="button">ê´€ë¦¬</button>
      <button id="logoutBtn" class="link-btn hidden" type="button">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <h1>ğŸ“Š ScoreBoard</h1>
    <div id="helloLine" class="subh hidden"></div>
    <div id="roleBadge" class="badge hidden"></div>

    <!-- ìµœì´ˆ ê´€ë¦¬ì ì„¤ì • -->
    <div id="setupSection" class="section hidden">
      <h3>ğŸ§© ìµœì´ˆ 1íšŒ: ê´€ë¦¬ì(ì˜) ìƒì„±</h3>
      <div class="muted">* ë¹„ë°€ë²ˆí˜¸ëŠ” SHA-256 í•´ì‹œë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
      <div class="row">
        <input id="setupName" placeholder="ê´€ë¦¬ì ì´ë¦„ (ì˜ˆ: ë°•ì¤€ì„œ)" />
        <input id="setupPw" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />
        <button id="setupBtn" class="ghost" type="button">ê´€ë¦¬ì ìƒì„±</button>
      </div>
    </div>

    <!-- ë¡œê·¸ì¸ -->
    <div id="loginSection" class="section hidden">
      <h3>ğŸ” ë¡œê·¸ì¸</h3>
      <input id="pwInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      <button id="loginBtn" type="button">ë¡œê·¸ì¸</button>
      <div class="muted">â€» ë¹„ë°€ë²ˆí˜¸ëŠ” í™”ë©´ì— í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    </div>

    <!-- ì„ íƒ -->
    <div id="pickSection" class="section hidden">
      <h3>ğŸ§­ ì„ íƒ</h3>

      <div class="row">
        <div style="flex:2 1 360px">
          <div class="muted">ì¢…ë¥˜ ì„ íƒ</div>
          <select id="typeSelect"></select>
        </div>
        <div style="flex:3 1 420px">
          <div class="muted">í˜„ì¬ ì„ íƒ</div>
          <div class="pill" id="currentPick">-</div>
        </div>
      </div>

      <div class="muted" style="margin-top:6px">ê³¼ëª© ì„ íƒ(ë²„íŠ¼)</div>
      <div id="subjectButtons" class="btnbar"></div>

      <div class="muted" style="margin-top:10px">íšŒì°¨ ì„ íƒ(ë²„íŠ¼)</div>
      <div id="roundButtons" class="btnbar"></div>
    </div>

    <!-- ëª©í‘œ(ì˜ ì„¤ì •/ì¹˜ ì—´ëŒ, ê·¸ ì™¸ ìˆ¨ê¹€) -->
    <div id="goalSection" class="section hidden">
      <h3>ğŸ¯ ëª©í‘œ ëŒ€í•™Â·í•™ê³¼</h3>
      <div id="goalSummary" class="muted">ëª©í‘œ ë¯¸ì„¤ì •</div>

      <div id="goalAdmin" class="hidden" style="margin-top:10px">
        <button id="toggleGoalEditorBtn" class="ghost" type="button">ëª©í‘œ ì„¤ì •/ìˆ˜ì • â–¼</button>
        <div id="goalEditor" class="hidden" style="margin-top:10px">
          <div class="row">
            <select id="goalSchool"></select>
            <select id="goalMajor"></select>
          </div>
          <div class="row">
            <button id="saveGoalBtn" class="ghost" type="button">ì €ì¥(ë®ì–´ì“°ê¸°)</button>
            <button id="deleteGoalBtn" class="danger" type="button">ëª©í‘œ ì‚­ì œ</button>
          </div>
          <div class="muted">* ëª©í‘œ ì„¤ì •/ì‚­ì œëŠ” ì˜ë§Œ ê°€ëŠ¥</div>
        </div>
      </div>
    </div>

    <!-- ì ìˆ˜ ì…ë ¥(ì˜ ì „ìš©) -->
    <div id="scoreEditorSection" class="section hidden">
      <h3>âœï¸ ì ìˆ˜ ì…ë ¥ (ì˜ ì „ìš©)</h3>

      <div class="row">
        <input id="roundInput" type="number" placeholder="íšŒì°¨ (ì˜ˆ: 1)" min="1" />
        <input id="scoreInput" type="number" placeholder="ì ìˆ˜" />
        <input id="percentileInput" type="number" placeholder="ë°±ë¶„ìœ„(êµ­/ìˆ˜/í™”1/ìƒ1ë§Œ, ì„ íƒ)" min="0" max="100" />
        <button id="saveScoreBtn" type="button">ì €ì¥/ì—…ë°ì´íŠ¸</button>
      </div>

      <div class="row">
        <button id="deleteRoundBtn" class="danger" type="button">ì„ íƒ íšŒì°¨ ì‚­ì œ(ë°ì´í„° í¬í•¨)</button>
      </div>

      <div class="muted">
        * ì˜ì–´/í•œêµ­ì‚¬ëŠ” ë°±ë¶„ìœ„ ì—†ìŒ(ìë™ ë“±ê¸‰).<br/>
        * íšŒì°¨ ì‚­ì œëŠ” (ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨) ê´€ë ¨ ì ìˆ˜Â·í†µê³„Â·ë‹¨ì› ë°ì´í„°ê¹Œì§€ ê°™ì´ ì‚­ì œë©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- ê·¸ë˜í”„ -->
    <div id="chartsSection" class="section hidden">
      <h3>ğŸ“ˆ ê·¸ë˜í”„</h3>
      <div class="grid4">
        <div class="card">
          <div class="t">ê·¸ë˜í”„ 1) ì„ íƒí•œ ì¢…ë¥˜ Â· ê³¼ëª©ì˜ íšŒì°¨ë³„ ì¶”ì´</div>
          <div class="d mini">X=íšŒì°¨, Y=ì ìˆ˜(0~100)</div>
          <canvas id="chart1"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 2) ê³¼ëª©(ë™ì¼) ê¸°ì¤€ ì¢…ë¥˜ë³„ í‰ê·  ë¹„êµ</div>
          <div class="d mini">X=ì¢…ë¥˜, Y=ê·¸ ì¢…ë¥˜ì˜ íšŒì°¨ í‰ê· ì ìˆ˜</div>
          <canvas id="chart2"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 3) ëŒ€í•™ ë¹„êµ(7ë§‰ëŒ€)</div>
          <div class="d mini">Y=ì ìˆ˜(ëª¨ì˜ê³ ì‚¬ ì ìˆ˜), ìš°ìƒí–¥ ì •ë ¬</div>
          <canvas id="chart3"></canvas>
          <div id="chart3Note" class="muted" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 4) ë‹¨ì›ë³„ ì ìˆ˜ ë¹„êµ</div>
          <div class="d mini">ì˜ê°€ ì…ë ¥í•œ ë‹¨ì› ì ìˆ˜</div>
          <canvas id="chart4"></canvas>
        </div>
      </div>

      <div id="pctAlert" class="muted" style="margin-top:10px"></div>
    </div>

    <!-- ìƒì„¸ -->
    <div id="detailSection" class="section hidden">
      <h3>ğŸ“Œ ì„ íƒ ìƒì„¸</h3>
      <div class="grid2">
        <div class="card">
          <div class="t">ë‚´ ì ìˆ˜(ì„ íƒ ì¡°í•©)</div>
          <div class="d">ì ìˆ˜: <b id="myScoreLabel">-</b>
            <span id="myExtraLabel" class="muted"></span>
          </div>
        </div>
        <div class="card">
          <div class="t">ì‹œí—˜ í†µê³„(ë“±ê¸‰ì»·/í‰ê· )</div>
          <div class="d">í‰ê· : <b id="avgLabel">-</b></div>
          <div class="muted">* ì»·ì´ ë¶€ì¡±í•˜ë©´ ë°±ë¶„ìœ„/ëŒ€í•™ê³„ì‚°ì´ ì œí•œë  ìˆ˜ ìˆì–´ìš”.</div>
        </div>
      </div>

      <div class="section" style="background:#fff;margin-top:12px">
        <h3 style="margin:0 0 8px">ë‹¨ì›ë³„ ì ìˆ˜</h3>
        <table>
          <thead><tr><th>ë‹¨ì›</th><th>ì ìˆ˜</th><th>ë§Œì </th></tr></thead>
          <tbody id="unitTable"></tbody>
        </table>
      </div>

      <div class="section" style="background:#fff;margin-top:12px">
        <h3 style="margin:0 0 8px">ğŸ“ ëŒ€í•™ ì¶”ì²œ</h3>
        <div class="muted">* ëŒ€í•™ì ìˆ˜ ì»·ê³¼ ë‚´ ëŒ€í•™ì ìˆ˜ ì°¨ì´ë¡œ ë¶„ë¥˜(ì ì •/ì†Œì‹ /ì•ˆì •/ìƒí–¥)</div>
        <div id="univGroups" style="margin-top:10px"></div>
        <div id="univNote" class="muted" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- ê´€ë¦¬ -->
    <div id="manageSection" class="section hidden">
      <h3>ğŸ›  ê´€ë¦¬ (ì˜ ì „ìš©)</h3>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§© ì¢…ë¥˜ ê´€ë¦¬</h3>
        <div class="row">
          <input id="newTypeInput" placeholder="ìƒˆ ì¢…ë¥˜ ì´ë¦„ (ì˜ˆ: í•™ë ¥í‰ê°€, ì„œë°”ì´ë²Œ)" />
          <button id="addTypeBtn" class="ghost" type="button">ì¢…ë¥˜ ì¶”ê°€</button>
        </div>
        <div id="typeList" class="muted"></div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ‘¤ ì‚¬ìš©ì ë“±ë¡(ì´ë¦„+ë¹„ë°€ë²ˆí˜¸+ë“±ê¸‰)</h3>
        <div class="row">
          <input id="newUserName" placeholder="ì´ë¦„" />
          <input id="newPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
          <select id="newGrade">
            <option value="ìˆ˜">ìˆ˜</option>
            <option value="ì•½">ì•½</option>
            <option value="í•œ">í•œ</option>
            <option value="ì¹˜">ì¹˜</option>
            <option value="ì˜">ì˜</option>
          </select>
          <button id="addUserBtn" class="ghost" type="button">ì¶”ê°€</button>
        </div>
        <div class="muted">* ë¹„ë°€ë²ˆí˜¸ëŠ” í•´ì‹œë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
        <div id="userList" style="margin-top:10px"></div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§¾ ë¡œê·¸ì¸ ê¸°ë¡(ì˜ë§Œ ì—´ëŒ)</h3>
        <div id="loginRecords" class="muted">ê¸°ë¡ ì—†ìŒ</div>
        <button id="clearLogsBtn" class="danger" type="button">ë¡œê·¸ì¸ ê¸°ë¡ ì „ì²´ ì‚­ì œ</button>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ“Š ì‹œí—˜ í†µê³„ ì…ë ¥(í‰ê· /ë“±ê¸‰ì»·)</h3>
        <div class="muted">í˜„ì¬ ì„ íƒ(ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨)ì— ëŒ€í•´ í‰ê· /ë“±ê¸‰ì»· ì €ì¥</div>
        <div class="row">
          <input id="statAvg" type="number" placeholder="í‰ê· (ì˜ˆ: 78)" />
          <input id="cut1" type="number" placeholder="1ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut2" type="number" placeholder="2ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut3" type="number" placeholder="3ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <div class="row">
          <input id="cut4" type="number" placeholder="4ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut5" type="number" placeholder="5ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut6" type="number" placeholder="6ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <div class="row">
          <input id="cut7" type="number" placeholder="7ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut8" type="number" placeholder="8ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut9" type="number" placeholder="9ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <button id="saveStatsBtn" class="ghost" type="button">í†µê³„ ì €ì¥/ì—…ë°ì´íŠ¸</button>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§© ë‹¨ì› ì ìˆ˜ ì…ë ¥(ê·¸ë˜í”„4)</h3>
        <div class="muted">í˜„ì¬ ì„ íƒ(ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨)ì— ë‹¨ì› ì ìˆ˜ ì¶”ê°€</div>
        <div class="row">
          <input id="unitName" placeholder="ë‹¨ì›ëª…(ì˜ˆ: ë¬¸í•™/ë¹„ë¬¸í•™, ë¯¸ì ë¶„-ìˆ˜ì—´)" />
          <input id="unitScore" type="number" placeholder="ì ìˆ˜" />
          <input id="unitMax" type="number" placeholder="ë§Œì (ì„ íƒ)" />
          <button id="addUnitBtn" class="ghost" type="button">ë‹¨ì› ì¶”ê°€</button>
        </div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ“ ëŒ€í•™ ë°ì´í„°(ì„œìš¸ëŒ€ ì§€ê·  v1)</h3>
        <div class="muted">* v5ì—ì„œëŠ” â€œì„œìš¸ëŒ€(ì§€ê· )â€ 5ê°œë§Œ ì‚¬ìš©(ìˆ˜ì˜ì˜ˆê³¼ ì—†ìŒ)</div>
        <div id="univAdminList" class="muted" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- ë§¨ ì•„ë˜: ê³„ì‚°ì‹/ì—…ë°ì´íŠ¸ -->
    <div class="footer">
      <div class="footer-row">
        <small id="verLine">v5</small>
        <div class="row" style="margin:0;gap:8px;justify-content:flex-end">
          <button id="openChangelogBtn" class="mini-btn" type="button">ì—…ë°ì´íŠ¸ ë‚´ì—­ ë³´ê¸°</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <details id="calcFinal">
          <summary>ğŸ“ ì ìˆ˜ ê³„ì‚° ë°©ì‹ (ìµœì¢…ë²„ì „) â–¼</summary>
          <div class="hr"></div>
          <div class="muted" style="margin-bottom:6px">í˜„ì¬ ìµœì¢…ë²„ì „ì—ëŠ” â€œì„œìš¸ëŒ€(ì§€ê· ) v1â€ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.</div>

          <div class="card" style="margin-top:10px">
            <div class="t">ì„œìš¸ëŒ€í•™êµ(ì§€ê· ) v1</div>
            <div class="d">
              ëŒ€í•™ì ìˆ˜ = (0.35Ã—ìˆ˜í•™ë°±ë¶„ìœ„ + 0.30Ã—êµ­ì–´ë°±ë¶„ìœ„ + 0.25Ã—íƒêµ¬í‰ê· ë°±ë¶„ìœ„ - ì˜ì–´ê°ì  - í•œêµ­ì‚¬ê°ì ) Ã· 0.90 Ã— 100
              <div class="muted" style="margin-top:6px">íƒêµ¬í‰ê·  = (í™”í•™1ë°±ë¶„ìœ„ + ìƒëª…ê³¼í•™1ë°±ë¶„ìœ„) / 2</div>
            </div>

            <div class="hr"></div>

            <div class="t">ì˜ì–´ ê°ì í‘œ(í™•ì •)</div>
            <table>
              <thead><tr><th>ë“±ê¸‰</th><th>ê°ì </th></tr></thead>
              <tbody id="engPenaltyTable"></tbody>
            </table>

            <div class="hr"></div>

            <div class="t">í•œêµ­ì‚¬ ê°ì í‘œ(í™•ì •)</div>
            <table>
              <thead><tr><th>ë“±ê¸‰</th><th>ê°ì </th></tr></thead>
              <tbody id="hisPenaltyTable"></tbody>
            </table>

            <div class="hr"></div>

            <div class="t">ì„œìš¸ëŒ€(ì§€ê· ) í•™ê³¼ ì»·(ëŒ€í•™ì ìˆ˜)</div>
            <div class="muted">* ì˜ì˜ˆê³¼ ì»·ì€ 99.5ë¡œ ê³ ì •, ë‚˜ë¨¸ì§€ëŠ” ì œê³µ í‘œ ë¹„ìœ¨ë¡œ ê³„ì‚°</div>
            <table>
              <thead><tr><th>ê³„ì—´</th><th>í•™êµ</th><th>í•™ê³¼</th><th>ì»·(ëŒ€í•™ì ìˆ˜)</th></tr></thead>
              <tbody id="snuCutsTable"></tbody>
            </table>
          </div>
        </details>

        <div class="hr"></div>

        <details id="calcHistory">
          <summary>ğŸ—‚ ì—­ëŒ€ ì ìˆ˜ ê³„ì‚° ë°©ì‹ â–¼</summary>
          <div class="muted" style="margin-top:8px">í˜„ì¬ëŠ” ë¹„ì–´ìˆëŠ” ê²ƒì´ ì •ìƒì…ë‹ˆë‹¤.</div>
        </details>
      </div>
    </div>

  </div>

  <!-- ëª¨ë‹¬ -->
  <div id="modalRoot" class="hidden"></div>

<script type="module">
  /* ============================
   *  Firebase (Firestore) ì„¤ì •
   * ============================ */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // âœ… ë„ˆê°€ ì¤€ Firebase ì„¤ì • ê·¸ëŒ€ë¡œ
  const firebaseConfig = {
    apiKey: "AIzaSyCuMFRksmpH0TuNqv3YoMa76DAAN4r3B84",
    authDomain: "scoreboard-d4bf9.firebaseapp.com",
    projectId: "scoreboard-d4bf9",
    storageBucket: "scoreboard-d4bf9.firebasestorage.app",
    messagingSenderId: "272482248722",
    appId: "1:272482248722:web:81147fe66081feb9da50cb",
    measurementId: "G-VC1922P5SV"
  };

  const APP_VERSION = 5;          // ê³µì§€/í‘œì‹œìš© ì•± ë²„ì „
  const DATA_SCHEMA_VERSION = 5;  // ë°ì´í„° êµ¬ì¡° ë²„ì „(ë§ˆì´ê·¸ë ˆì´ì…˜ìš©)

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // âœ… ì¤‘ìš”: ë¬¸ì„œ ê²½ë¡œ â€œë²„ì „ ìƒê´€ì—†ì´ ê³ ì •â€ (v5ë¶€í„° ë°ì´í„° ì•ˆ ë‚ ì•„ê°€ê²Œ)
  const STATE_DOC_PATH = ["public", "state"]; // collection, docId (ì ˆëŒ€ ë²„ì „ë³„ë¡œ ë°”ê¾¸ì§€ ë§ê¸°)

  /* ============================
   *  ê¸°ë³¸ ìœ í‹¸/ìƒìˆ˜
   * ============================ */
  const $ = (id)=>document.getElementById(id);
  const escapeHtml = (s)=>String(s??"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const show = (el, yes)=> el.classList.toggle("hidden", !yes);
  const uid = ()=> Math.random().toString(36).slice(2) + Date.now().toString(36);

  // ê³¼ëª© 6ê°œ ê³ ì •
  const SUBJECTS = ["êµ­ì–´","ìˆ˜í•™","ì˜ì–´","í™”í•™1","ìƒëª…ê³¼í•™1","í•œêµ­ì‚¬"];

  // ë“±ê¸‰ ì´ëª¨ì§€
  const ROLE_EMOJI = { "ì˜":"ğŸ‘‘", "ì¹˜":"ğŸ¦·", "í•œ":"ğŸŒ¿", "ì•½":"ğŸ’Š", "ìˆ˜":"ğŸ“" };

  // ê¶Œí•œ: ì˜ë§Œ write
  const isAdmin = (u)=> u?.grade === "ì˜";

  // ê³µì§€/í‘œì‹œìš© ê¶Œí•œ ë‹¨ê³„(ì˜ë§Œ, ì˜ì¹˜, ì˜ì¹˜í•œ, ì˜ì¹˜í•œì•½, ëª¨ë‘)
  const roleOrder = ["ìˆ˜","ì•½","í•œ","ì¹˜","ì˜"]; // ë‚®â†’ë†’
  const roleGE = (userGrade, minGrade)=>{
    return roleOrder.indexOf(userGrade) >= roleOrder.indexOf(minGrade);
  };

  // ì˜ì–´/í•œêµ­ì‚¬ ì ìˆ˜ ë²”ìœ„
  const SCORE_MAX = (subject)=>{
    if(subject==="í™”í•™1"||subject==="ìƒëª…ê³¼í•™1"||subject==="í•œêµ­ì‚¬") return 50;
    return 100;
  };

  // ì˜ì–´/í•œêµ­ì‚¬ ë“±ê¸‰ ìë™(í™•ì •)
  function scoreToEnglishGrade(score){
    if(score>=90) return 1;
    if(score>=80) return 2;
    if(score>=70) return 3;
    if(score>=60) return 4;
    if(score>=50) return 5;
    if(score>=40) return 6;
    if(score>=30) return 7;
    if(score>=20) return 8;
    return 9;
  }
  function scoreToHistoryGrade(score){
    // í™•ì •: 1ë“±ê¸‰ 50~40
    if(score>=40) return 1;
    if(score>=35) return 2;
    if(score>=30) return 3;
    if(score>=25) return 4;
    if(score>=20) return 5;
    if(score>=15) return 6;
    if(score>=10) return 7;
    if(score>=5)  return 8;
    return 9;
  }

  // ê°ì í‘œ(í™•ì •)
  const ENG_PENALTY = {1:0,2:1,3:2,4:4,5:6,6:8,7:10,8:12,9:14};
  const HIS_PENALTY = {1:0,2:0,3:1,4:2,5:4,6:6,7:8,8:10,9:12};

  // ë°±ë¶„ìœ„ ê²½ê³„(ê³ ì •)
  const PCT_FLOOR = {1:96,2:89,3:77,4:60,5:40,6:23,7:11,8:4,9:0};

  /* ============================
   *  ì„œìš¸ëŒ€(ì§€ê· ) ì»·(ëŒ€í•™ì ìˆ˜) í™•ì •
   *  - ì˜ì˜ˆê³¼ ì»· = 99.5 ê³ ì •
   *  - ë‚˜ë¨¸ì§€ 4ê°œëŠ” ì œê³µ í‘œ(ë³€í™˜ì ìˆ˜) ë¹„ìœ¨ë¡œ ê³„ì‚°
   *  - ìˆ˜ì˜ì˜ˆê³¼ ì‚­ì œ ë°˜ì˜
   * ============================ */
  const SNU_BASE = {
    baseConv: 434.1,
    anchorCut: 99.5,
    rows: [
      { track:"ê³µí•™ê³„ì—´", school:"ì„œìš¸ëŒ€í•™êµ(ì§€ê· )", major:"ê´‘ì—­", conv:414.1 },
      { track:"ìì—°ê³„ì—´", school:"ì„œìš¸ëŒ€í•™êµ(ì§€ê· )", major:"ì²¨ë‹¨ìœµí•©í•™ë¶€", conv:409.2 },
      { track:"ì•½í•™ê³¼",   school:"ì„œìš¸ëŒ€í•™êµ(ì§€ê· )", major:"ì•½í•™ê³„ì—´", conv:416.7 },
      { track:"ì¹˜ì˜í•™ê³¼", school:"ì„œìš¸ëŒ€í•™êµ(ì§€ê· )", major:"ì¹˜ì˜í•™ê³¼", conv:424.7 },
      { track:"ì˜ì˜ˆê³¼",   school:"ì„œìš¸ëŒ€í•™êµ(ì§€ê· )", major:"ì˜ì˜ˆê³¼",   conv:434.1 }
    ]
  };

  function buildSnuCuts(){
    return SNU_BASE.rows.map(r=>{
      const ratio = r.conv / SNU_BASE.baseConv;
      let cut = SNU_BASE.anchorCut * ratio;
      if(r.major==="ì˜ì˜ˆê³¼") cut = SNU_BASE.anchorCut;
      cut = Math.round(cut*100)/100;
      return { ...r, cutCollegeScore: cut };
    });
  }

  /* ============================
   *  ì„œë²„ ìƒíƒœ ìŠ¤í‚¤ë§ˆ
   * ============================ */
  function defaultState(){
    return {
      schemaVersion: DATA_SCHEMA_VERSION,  // âœ… ë°ì´í„° êµ¬ì¡° ë²„ì „
      users: [], // {id,name,grade,pwHash,createdAt}
      logs: [],  // {time,name,grade}
      types: [], // {id,name,createdAt}
      rounds: [], // {id,typeId,subject,round,createdAt}
      scores: [], // {id,typeId,subject,round,score,percentile,grade,updatedAt}
      stats: [],  // {id,typeId,subject,round,avg,cut1..cut9,updatedAt}
      units: [],  // {id,typeId,subject,round,unit,score,maxScore,updatedAt}
      goal: null, // {school, major, updatedAt}
      seen: {},   // { [userId]: { seenVersion: number } }
      univ: {
        snuJigyun: buildSnuCuts()
      },
      updatedAt: null
    };
  }

  let state = defaultState();
  let currentUser = null; // {id,name,grade}
  let selectedTypeId = null;
  let selectedSubject = SUBJECTS[0];
  let selectedRound = null;

  let c1=null,c2=null,c3=null,c4=null;

  /* ============================
   *  í•´ì‹œ
   * ============================ */
  async function sha256(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  /* ============================
   *  Firestore load/save
   * ============================ */
  const stateRef = doc(db, ...STATE_DOC_PATH);

  async function loadStateFromServer(){
    const snap = await getDoc(stateRef);
    if(!snap.exists()){
      state = defaultState();
      await setDoc(stateRef, state, { merge: true });
      return;
    }
    const data = snap.data();
    state = { ...defaultState(), ...data };

    // ìµœì†Œ ë³´ì •
    if(!state.univ?.snuJigyun) state.univ = { snuJigyun: buildSnuCuts() };
    if(!Array.isArray(state.univ.snuJigyun)) state.univ.snuJigyun = buildSnuCuts();
    if(!state.seen) state.seen = {};
    if(!Number.isFinite(Number(state.schemaVersion))) state.schemaVersion = DATA_SCHEMA_VERSION;

    // (ë‚˜ì¤‘ì— v6, v7ì—ì„œ schemaVersion ë³´ê³  ë§ˆì´ê·¸ë ˆì´ì…˜ ì²˜ë¦¬)
  }

  async function saveStateToServer(force=false){
    if(!force && currentUser && !isAdmin(currentUser)) return;
    state.updatedAt = Date.now();
    await setDoc(stateRef, state, { merge: true });
  }

  function startRealtimeSync(){
    onSnapshot(stateRef, (snap)=>{
      if(!snap.exists()) return;
      const incoming = snap.data();
      state = { ...defaultState(), ...incoming };
      if(!state.univ?.snuJigyun) state.univ = { snuJigyun: buildSnuCuts() };

      if(currentUser){
        refreshAll();
      }else{
        boot();
      }
    });
  }

  /* ============================
   *  UI ì´ˆê¸°í™”/ë¶€íŒ…
   * ============================ */
  function boot(){
    const hasUsers = state.users.length > 0;
    show($("setupSection"), !hasUsers);
    show($("loginSection"), hasUsers);

    show($("pickSection"), false);
    show($("scoreEditorSection"), false);
    show($("chartsSection"), false);
    show($("detailSection"), false);
    show($("goalSection"), false);

    show($("manageTab"), false);
    show($("manageSection"), false);
    show($("logoutBtn"), false);
    show($("roleBadge"), false);
    show($("helloLine"), false);

    $("pwInput").value = "";
  }

  function setHello(){
    if(!currentUser) return;
    $("helloLine").textContent = `ì•ˆë…•í•˜ì„¸ìš”, ${currentUser.name}ë‹˜`;
  }
  function setBadges(){
    if(!currentUser) return;
    const emo = ROLE_EMOJI[currentUser.grade] ?? "";
    $("roleBadge").textContent = `í˜„ì¬ ë“±ê¸‰: ${emo}${currentUser.grade}`;
  }

  function destroyCharts(){
    if(c1) c1.destroy(); if(c2) c2.destroy(); if(c3) c3.destroy(); if(c4) c4.destroy();
    c1=c2=c3=c4=null;
  }

  function refreshAll(){
    renderSubjectButtons();
    renderTypeSelect();
    renderRoundButtons();
    updatePickLabel();
    updateDetail();
    renderAllCharts();
    renderGoalSection();
    renderUniversityGroups();
    renderPctAlert();
    if(isAdmin(currentUser)){
      renderManageAll();
    }
    maybeShowChangelogModal();
  }

  function afterLogin(){
    show($("loginSection"), false);
    show($("setupSection"), false);

    show($("pickSection"), true);
    show($("chartsSection"), true);
    show($("detailSection"), true);
    show($("logoutBtn"), true);

    show($("roleBadge"), true);
    show($("helloLine"), true);
    setHello();
    setBadges();

    show($("manageTab"), isAdmin(currentUser));
    show($("scoreEditorSection"), isAdmin(currentUser));
    show($("goalSection"), roleGE(currentUser.grade, "ì¹˜"));
    show($("manageSection"), false);

    if(!selectedTypeId && state.types.length>0) selectedTypeId = state.types[0].id;
    selectedSubject = selectedSubject || SUBJECTS[0];

    refreshAll();
  }

  /* ============================
   *  ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ/ê¸°ë¡
   * ============================ */
  function addLog(name, grade){
    state.logs.push({ time: new Date().toLocaleString(), name, grade });
    saveStateToServer(false);
  }

  async function loginWithPassword(pw){
    const hash = await sha256(pw);
    const user = state.users.find(u => u.pwHash === hash);
    if(!user) return null;
    return { id:user.id, name:user.name, grade:user.grade };
  }

  $("logoutBtn").addEventListener("click", ()=>{
    currentUser = null;
    destroyCharts();
    boot();
  });

  $("loginBtn").addEventListener("click", async ()=>{
    const pw = $("pwInput").value.trim();
    if(!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");
    const user = await loginWithPassword(pw);
    if(!user) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    currentUser = user;
    addLog(user.name, user.grade);
    afterLogin();
  });

  /* ìµœì´ˆ ê´€ë¦¬ì ìƒì„± */
  $("setupBtn").addEventListener("click", async ()=>{
    const name = $("setupName").value.trim();
    const pw = $("setupPw").value.trim();
    if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
    if(!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");
    const pwHash = await sha256(pw);
    state.users.push({ id: uid(), name, grade:"ì˜", pwHash, createdAt: Date.now() });

    if(state.types.length===0){
      state.types.push({ id: uid(), name:"í•™ë ¥í‰ê°€", createdAt: Date.now() });
      state.types.push({ id: uid(), name:"ì„œë°”ì´ë²Œ", createdAt: Date.now() });
    }
    await saveStateToServer(true);
    alert("ê´€ë¦¬ì ìƒì„± ì™„ë£Œ! ì´ì œ ë¡œê·¸ì¸í•´ì¤˜.");
    boot();
  });

  /* ============================
   *  ê³µì§€(ì—…ë°ì´íŠ¸) ì‹œìŠ¤í…œ
   * ============================ */
  const CHANGELOG = {
    5: [
      { minRole:"ìˆ˜", title:"v5ë¶€í„° ë°ì´í„° ì´ˆê¸°í™” ë°©ì§€", bullets:[
        "Firestore ë¬¸ì„œ ê²½ë¡œë¥¼ public/stateë¡œ ê³ ì •(ë²„ì „ì—…í•´ë„ ë°ì´í„° ìœ ì§€)",
        "ì•± ë²„ì „(APP_VERSION)ê³¼ ë°ì´í„° ë²„ì „(schemaVersion) ë¶„ë¦¬"
      ]},
      { minRole:"ìˆ˜", title:"ì—…ë°ì´íŠ¸ ê³µì§€ ì‹œìŠ¤í…œ", bullets:[
        "ë¡œê·¸ì¸ ì§í›„ ê³„ì •ë³„(ë¹„ë°€ë²ˆí˜¸/IDë³„) ë²„ì „ë‹¹ 1íšŒë§Œ ê³µì§€ í‘œì‹œ",
        "ë‹«ê¸° ëˆ„ë¥´ë©´ ìë™ ì¬í‘œì‹œ ì—†ìŒ",
        "í•˜ë‹¨ì—ì„œ ë²„ì „ë³„(v5, v6...) ì—…ë°ì´íŠ¸ ë‚´ì—­ ë‹¤ì‹œ ë³´ê¸°"
      ]},
      { minRole:"ì¹˜", title:"ëª©í‘œ ëŒ€í•™Â·í•™ê³¼(ì˜ ì„¤ì • / ì¹˜ ì—´ëŒ)", bullets:[
        "ëª©í‘œëŠ” ì „ì²´ ê³µí†µ 1ê°œ(í•™ë…„ë„ êµ¬ë¶„ ì—†ìŒ)",
        "ì˜ë§Œ ì„¤ì •/ìˆ˜ì •/ì‚­ì œ, ì¹˜ëŠ” ë³´ê¸°ë§Œ ê°€ëŠ¥",
        "í•œ/ì•½/ìˆ˜ëŠ” ëª©í‘œ ì˜ì—­ ìˆ¨ê¹€"
      ]},
      { minRole:"ìˆ˜", title:"ì˜ì–´/í•œêµ­ì‚¬", bullets:[
        "ë°±ë¶„ìœ„ ì™„ì „ ì‚­ì œ",
        "ì ìˆ˜ ì…ë ¥ ì‹œ ë“±ê¸‰ ìë™ ê³„ì‚°",
        "ì…ë ¥ ë²”ìœ„ ì œí•œ(ì˜ì–´ 0~100 / í•œêµ­ì‚¬ 0~50)"
      ]},
      { minRole:"ìˆ˜", title:"ê·¸ë˜í”„3 ëŒ€í•™ ë¹„êµ(7ë§‰ëŒ€)", bullets:[
        "Yì¶•ì€ ì ìˆ˜(ëª¨ì˜ê³ ì‚¬ ì ìˆ˜)ë§Œ ì‚¬ìš©",
        "ë‚´ ë§‰ëŒ€ 1 + ì•„ë˜3 + ìœ„3 = ì´ 7ê°œ ê³ ì •",
        "ìš°ìƒí–¥ ì •ë ¬"
      ]},
      { minRole:"ìˆ˜", title:"ëŒ€í•™êµ ê´€ë ¨ ë°ì´í„° ì—…ë°ì´íŠ¸", bullets:[
        "ì„œìš¸ëŒ€í•™êµ(ì§€ê· ) ë°ì´í„° ë°˜ì˜(5ê°œ í•™ê³¼)",
        "ì˜ì˜ˆê³¼ ì»·=99.5 ê³ ì •, ë‚˜ë¨¸ì§€ëŠ” ì œê³µ í‘œ ë¹„ìœ¨ë¡œ ê³„ì‚°",
        "ëŒ€í•™ì¶”ì²œ ë¶„ë¥˜: ì ì •/ì†Œì‹ /ì•ˆì •/ìƒí–¥"
      ]},
      { minRole:"ìˆ˜", title:"ë°±ë¶„ìœ„ ê´€ë ¨ ì•Œë¦¼", bullets:[
        "ì»· ë¶€ì¡± ì‹œ ë¶„ì„/ê³„ì‚° ì œí•œ ì•ˆë‚´",
        "ì˜ì–´/í•œêµ­ì‚¬ëŠ” ë°±ë¶„ìœ„ ë¯¸ì‚¬ìš© ì•ˆë‚´"
      ]}
    ]
  };

  function userSeenVersion(){
    if(!currentUser) return 0;
    return Number(state.seen?.[currentUser.id]?.seenVersion ?? 0);
  }

  function markSeen(version){
    if(!currentUser) return;
    if(!state.seen) state.seen = {};
    state.seen[currentUser.id] = { seenVersion: version };
    saveStateToServer(false);
  }

  function renderChangelog(version, forUserGrade){
    const items = CHANGELOG[version] || [];
    const filtered = items.filter(it => roleGE(forUserGrade, it.minRole));
    if(filtered.length===0) return "<div class='muted'>í‘œì‹œí•  ì—…ë°ì´íŠ¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
    return filtered.map(it=>{
      return `
        <div class="card" style="margin-top:10px">
          <div class="t">${escapeHtml(it.title)}</div>
          <div class="d">
            <ul style="margin:8px 0 0 18px">
              ${it.bullets.map(b=>`<li>${escapeHtml(b)}</li>`).join("")}
            </ul>
          </div>
        </div>
      `;
    }).join("");
  }

  function openModal(html){
    const root = $("modalRoot");
    root.innerHTML = `
      <div class="modal-backdrop">
        <div class="modal">
          ${html}
        </div>
      </div>
    `;
    root.classList.remove("hidden");
  }
  function closeModal(){
    const root = $("modalRoot");
    root.classList.add("hidden");
    root.innerHTML = "";
  }

  function maybeShowChangelogModal(){
    if(!currentUser) return;
    const seen = userSeenVersion();
    if(seen >= APP_VERSION) return;

    const html = `
      <h3>ğŸ“Œ ScoreBoard v${APP_VERSION} ì—…ë°ì´íŠ¸</h3>
      <div class="muted">* ë‹«ìœ¼ë©´ ë‹¤ìŒë¶€í„° ìë™ìœ¼ë¡œ ëœ¨ì§€ ì•Šê³ , í•˜ë‹¨ì—ì„œ ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆì–´ìš”.</div>
      <div style="margin-top:10px">
        ${renderChangelog(APP_VERSION, currentUser.grade)}
      </div>
      <div class="actions">
        <button id="changelogCloseBtn" class="ghost" type="button">ë‹«ê¸°</button>
      </div>
    `;
    openModal(html);
    $("changelogCloseBtn").onclick = ()=>{
      markSeen(APP_VERSION);
      closeModal();
    };
  }

  $("openChangelogBtn").addEventListener("click", ()=>{
    if(!currentUser) return;
    const html = `
      <h3>ğŸ“Œ ì—…ë°ì´íŠ¸ ë‚´ì—­</h3>
      <div class="muted">ë²„ì „ì„ ì„ íƒí•´ì„œ ë³¼ ìˆ˜ ìˆì–´ìš”.</div>
      <div class="row">
        <select id="verSelect"></select>
        <button id="verOpenBtn" class="ghost" type="button">ë³´ê¸°</button>
        <button id="verCloseBtn" type="button">ë‹«ê¸°</button>
      </div>
      <div id="verBody" style="margin-top:10px"></div>
    `;
    openModal(html);
    const vs = $("verSelect");
    const versions = Object.keys(CHANGELOG).map(Number).sort((a,b)=>b-a);
    versions.forEach(v=>{
      const opt = document.createElement("option");
      opt.value = String(v);
      opt.textContent = `v${v}`;
      vs.appendChild(opt);
    });
    const render = ()=>{
      const v = Number(vs.value);
      $("verBody").innerHTML = renderChangelog(v, currentUser.grade);
    };
    render();
    $("verOpenBtn").onclick = render;
    $("verCloseBtn").onclick = closeModal;
  });

  /* ============================
   *  ì„ íƒ UI: ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨
   * ============================ */
  function renderTypeSelect(){
    const sel = $("typeSelect");
    sel.innerHTML = "";
    if(state.types.length===0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "ì¢…ë¥˜ ì—†ìŒ(ì˜ê°€ ê´€ë¦¬ì—ì„œ ì¶”ê°€)";
      sel.appendChild(opt);
      sel.disabled = true;
      selectedTypeId = null;
      return;
    }
    sel.disabled = false;
    state.types.forEach(t=>{
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      sel.appendChild(opt);
    });
    if(!selectedTypeId || !state.types.some(t=>t.id===selectedTypeId)){
      selectedTypeId = state.types[0].id;
    }
    sel.value = selectedTypeId;
  }

  $("typeSelect").addEventListener("change", ()=>{
    selectedTypeId = $("typeSelect").value;
    selectedRound = null;
    renderRoundButtons();
    updatePickLabel();
    updateDetail();
    renderAllCharts();
    renderUniversityGroups();
    renderPctAlert();
  });

  function renderSubjectButtons(){
    const wrap = $("subjectButtons");
    wrap.innerHTML = "";
    SUBJECTS.forEach(subj=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "ghost";
      btn.textContent = subj;
      btn.onclick = ()=>{
        selectedSubject = subj;
        selectedRound = null;
        markActiveButtons();
        renderRoundButtons();
        updatePickLabel();
        updateDetail();
        renderAllCharts();
        renderUniversityGroups();
        renderPctAlert();
      };
      wrap.appendChild(btn);
    });
    markActiveButtons();
  }

  function markActiveButtons(){
    [...$("subjectButtons").querySelectorAll("button")].forEach(b=>{
      b.classList.toggle("active", b.textContent === selectedSubject);
    });
    [...$("roundButtons").querySelectorAll("button")].forEach(b=>{
      const r = Number(b.dataset.round);
      b.classList.toggle("active", Number.isFinite(r) && r === selectedRound);
    });
  }

  function roundsInScope(){
    if(!selectedTypeId) return [];
    return state.rounds
      .filter(r=>r.typeId===selectedTypeId && r.subject===selectedSubject)
      .map(r=>Number(r.round))
      .filter(n=>Number.isFinite(n))
      .sort((a,b)=>a-b);
  }

  function ensureRoundExists(typeId, subject, round){
    const exists = state.rounds.some(r=>r.typeId===typeId && r.subject===subject && Number(r.round)===Number(round));
    if(exists) return;
    state.rounds.push({ id: uid(), typeId, subject, round:Number(round), createdAt: Date.now() });
  }

  function renderRoundButtons(){
    const wrap = $("roundButtons");
    wrap.innerHTML = "";
    if(!selectedTypeId){
      wrap.innerHTML = `<span class="muted">ì¢…ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜</span>`;
      return;
    }
    const rounds = roundsInScope();
    if(rounds.length===0){
      wrap.innerHTML = `<span class="muted">íšŒì°¨ ì—†ìŒ(ì˜ê°€ íšŒì°¨ ìƒì„± ë˜ëŠ” ì ìˆ˜ ì €ì¥)</span>`;
      selectedRound = null;
      markActiveButtons();
      return;
    }
    rounds.forEach(r=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "ghost";
      btn.textContent = `${r}íšŒ`;
      btn.dataset.round = String(r);
      btn.onclick = ()=>{
        selectedRound = r;
        markActiveButtons();
        updatePickLabel();
        updateDetail();
        renderAllCharts();
        renderUniversityGroups();
        renderPctAlert();
      };
      wrap.appendChild(btn);
    });
    if(selectedRound==null) selectedRound = rounds[0];
    markActiveButtons();
  }

  function updatePickLabel(){
    const typeName = state.types.find(t=>t.id===selectedTypeId)?.name ?? "-";
    const rnd = (selectedRound==null) ? "-" : `${selectedRound}íšŒ`;
    $("currentPick").textContent = `${typeName} / ${selectedSubject} / ${rnd}`;
  }

  /* ============================
   *  ë°ì´í„° ì¡°íšŒ í—¬í¼
   * ============================ */
  function getMyScoreDoc(){
    if(!selectedTypeId || selectedRound==null) return null;
    return state.scores.find(s =>
      s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===Number(selectedRound)
    ) ?? null;
  }

  function getStatDoc(){
    if(!selectedTypeId || selectedRound==null) return null;
    return state.stats.find(s =>
      s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===Number(selectedRound)
    ) ?? null;
  }

  function getUnitDocs(){
    if(!selectedTypeId || selectedRound==null) return [];
    return state.units
      .filter(u => u.typeId===selectedTypeId && u.subject===selectedSubject && Number(u.round)===Number(selectedRound))
      .slice()
      .sort((a,b)=>(a.unit||"").localeCompare(b.unit||"", "ko"));
  }

  function getAvgPercentileOfSubject(subject){
    const rows = state.scores
      .filter(s=>s.subject===subject)
      .map(s=>Number(s.percentile))
      .filter(v=>Number.isFinite(v));
    if(rows.length===0) return null;
    const avg = rows.reduce((a,b)=>a+b,0)/rows.length;
    return Math.round(avg*100)/100;
  }

  function getCurrentPercentile(subject){
    if(!selectedTypeId || selectedRound==null) return null;
    const doc = state.scores.find(s=>s.typeId===selectedTypeId && s.subject===subject && Number(s.round)===Number(selectedRound));
    const v = Number(doc?.percentile);
    return Number.isFinite(v) ? v : null;
  }

  /* ============================
   *  ë°±ë¶„ìœ„ ì¶”ì •(ì»· 2ê°œ ì´ìƒ í•„ìš”)
   * ============================ */
  function estimatePercentileFromCuts(subject, score, statDoc){
    if(!statDoc) return { ok:false, reason:"ë“±ê¸‰ì»· ì—†ìŒ" };
    const cuts = [];
    for(let i=1;i<=9;i++){
      const v = statDoc["cut"+i];
      if(v!=null && v!=="" && Number.isFinite(Number(v))){
        cuts.push({ grade:i, cutScore:Number(v), pctFloor:PCT_FLOOR[i] });
      }
    }
    if(cuts.length<2) return { ok:false, reason:"ì»· 2ê°œ ë¯¸ë§Œ" };

    cuts.sort((a,b)=>b.cutScore-a.cutScore);
    const maxScore = SCORE_MAX(subject);

    const top = cuts.find(c=>c.grade===1) || cuts[0];
    if(score >= top.cutScore){
      const span = Math.max(1, maxScore - top.cutScore);
      const pct = top.pctFloor + (score - top.cutScore) * (100 - top.pctFloor) / span;
      return { ok:true, pct: clampPct(pct) };
    }

    for(let idx=0; idx<cuts.length-1; idx++){
      const upper = cuts[idx];
      const lower = cuts[idx+1];
      if(score < upper.cutScore && score >= lower.cutScore){
        const span = Math.max(1, upper.cutScore - lower.cutScore);
        const pct = lower.pctFloor + (score - lower.cutScore) * (upper.pctFloor - lower.pctFloor) / span;
        return { ok:true, pct: clampPct(pct) };
      }
    }

    const bottom = cuts[cuts.length-1];
    if(score < bottom.cutScore){
      const span = Math.max(1, bottom.cutScore);
      const pct = 0 + score * (bottom.pctFloor - 0) / span;
      return { ok:true, pct: clampPct(pct) };
    }

    return { ok:false, reason:"ì¶”ì • ì‹¤íŒ¨" };
  }

  function clampPct(p){
    const v = Number(p);
    if(!Number.isFinite(v)) return null;
    return Math.max(0, Math.min(100, Math.round(v*100)/100));
  }

  /* ============================
   *  ëŒ€í•™ì ìˆ˜(ì„œìš¸ëŒ€ ì§€ê·  v1)
   * ============================ */
  function calcCollegeScoreSnuJigyunV1(inputs){
    const { korPct, mathPct, chemPct, bioPct, engGrade, hisGrade } = inputs;

    if([korPct, mathPct, chemPct, bioPct].some(v=>!Number.isFinite(Number(v)))) return { ok:false, reason:"í•„ìˆ˜ ë°±ë¶„ìœ„ ë¶€ì¡±" };
    if(!Number.isFinite(Number(engGrade)) || !Number.isFinite(Number(hisGrade))) return { ok:false, reason:"ì˜ì–´/í•œêµ­ì‚¬ ë“±ê¸‰ ë¶€ì¡±" };

    const íƒêµ¬í‰ê·  = (Number(chemPct) + Number(bioPct)) / 2;

    const raw = 0.35*Number(mathPct) + 0.30*Number(korPct) + 0.25*íƒêµ¬í‰ê· 
      - (ENG_PENALTY[Number(engGrade)] ?? 0)
      - (HIS_PENALTY[Number(hisGrade)] ?? 0);

    const uni = (raw / 0.90) * 100;
    const uni2 = Math.round(uni*100)/100;
    return { ok:true, collegeScore: Math.max(0, Math.min(100, uni2)), raw: Math.round(raw*100)/100 };
  }

  /* ============================
   *  ëŒ€í•™ì¶”ì²œ ë¶„ë¥˜ ê·œì¹™(í™•ì •)
   * ============================ */
  function classify(diff){
    if(!Number.isFinite(diff)) return "ê³„ì‚°ë¶ˆê°€";
    if(Math.abs(diff) <= 1.0) return "ì ì •";
    if(diff >= 1.0) return "ì•ˆì •";
    if(diff > -3.0 && diff < -1.0) return "ì†Œì‹ ";
    return "ìƒí–¥";
  }

  function round1(x){
    const v = Number(x);
    if(!Number.isFinite(v)) return null;
    return Math.round(v*10)/10;
  }

  /* ============================
   *  ì ìˆ˜ ì €ì¥/ì—…ë°ì´íŠ¸/íšŒì°¨ ì‚­ì œ (ì˜ ì „ìš©)
   * ============================ */
  $("saveScoreBtn").addEventListener("click", async ()=>{
    if(!isAdmin(currentUser)) return;

    if(!selectedTypeId) return alert("ì¢…ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");
    const round = Number($("roundInput").value);
    if(!Number.isFinite(round) || round<1) return alert("íšŒì°¨ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");

    const score = Number($("scoreInput").value);
    if(!Number.isFinite(score)) return alert("ì ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");

    const max = SCORE_MAX(selectedSubject);
    if(score < 0 || score > max) return alert(`${selectedSubject} ì ìˆ˜ëŠ” 0~${max} ë²”ìœ„ì•¼.`);

    ensureRoundExists(selectedTypeId, selectedSubject, round);

    let percentile = null;
    let grade = null;

    if(selectedSubject==="ì˜ì–´"){
      grade = scoreToEnglishGrade(score);
    }else if(selectedSubject==="í•œêµ­ì‚¬"){
      grade = scoreToHistoryGrade(score);
    }else{
      const pctRaw = $("percentileInput").value.trim();
      percentile = (pctRaw==="") ? null : Number(pctRaw);
      if(percentile!=null && (!Number.isFinite(percentile) || percentile<0 || percentile>100)){
        return alert("ë°±ë¶„ìœ„ëŠ” 0~100 ë²”ìœ„ ìˆ«ìì•¼.");
      }
      if(percentile==null){
        const st = state.stats.find(s=>s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===round) ?? null;
        const est = estimatePercentileFromCuts(selectedSubject, score, st);
        if(est.ok) percentile = est.pct;
      }
    }

    const existing = state.scores.find(s=>s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===round);
    if(existing){
      existing.score = score;
      existing.percentile = percentile;
      existing.grade = grade;
      existing.updatedAt = Date.now();
    }else{
      state.scores.push({
        id: uid(),
        typeId: selectedTypeId,
        subject: selectedSubject,
        round,
        score,
        percentile,
        grade,
        updatedAt: Date.now()
      });
    }

    await saveStateToServer(false);

    $("roundInput").value="";
    $("scoreInput").value="";
    $("percentileInput").value="";

    selectedRound = round;
    renderRoundButtons();
    updatePickLabel();
    updateDetail();
    renderAllCharts();
    renderUniversityGroups();
    renderPctAlert();
  });

  $("deleteRoundBtn").addEventListener("click", async ()=>{
    if(!isAdmin(currentUser)) return;
    if(!selectedTypeId || selectedRound==null) return alert("ì¢…ë¥˜/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");

    const typeName = state.types.find(t=>t.id===selectedTypeId)?.name ?? "";
    if(!confirm(`ì •ë§ ì‚­ì œí• ê¹Œ?\n${typeName} / ${selectedSubject} / ${selectedRound}íšŒ\n(ì ìˆ˜Â·í†µê³„Â·ë‹¨ì› ë°ì´í„° í¬í•¨)`)) return;

    state.rounds = state.rounds.filter(r=>!(r.typeId===selectedTypeId && r.subject===selectedSubject && Number(r.round)===Number(selectedRound)));
    state.scores = state.scores.filter(s=>!(s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===Number(selectedRound)));
    state.stats  = state.stats .filter(s=>!(s.typeId===selectedTypeId && s.subject===selectedSubject && Number(s.round)===Number(selectedRound)));
    state.units  = state.units .filter(u=>!(u.typeId===selectedTypeId && u.subject===selectedSubject && Number(u.round)===Number(selectedRound)));

    await saveStateToServer(false);

    selectedRound = null;
    destroyCharts();
    renderRoundButtons();
    updatePickLabel();
    updateDetail();
    renderAllCharts();
    renderUniversityGroups();
    renderPctAlert();
  });

  /* ============================
   *  í†µê³„ ì €ì¥(ì˜)
   * ============================ */
  $("saveStatsBtn").addEventListener("click", async ()=>{
    if(!isAdmin(currentUser)) return;
    if(!selectedTypeId || selectedRound==null) return alert("ì¢…ë¥˜/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");

    const avgRaw = $("statAvg").value.trim();
    const avg = (avgRaw==="") ? null : Number(avgRaw);
    if(avg!=null && !Number.isFinite(avg)) return alert("í‰ê· ì€ ìˆ«ìì•¼.");

    const data = {
      id: uid(),
      typeId: selectedTypeId,
      subject: selectedSubject,
      round: Number(selectedRound),
      avg: avg,
      updatedAt: Date.now()
    };
    for(let i=1;i<=9;i++){
      const v = $("cut"+i).value.trim();
      data["cut"+i] = (v==="") ? null : Number(v);
      if(data["cut"+i]!=null && !Number.isFinite(data["cut"+i])) data["cut"+i]=null;
    }

    const existing = state.stats.find(s=>s.typeId===data.typeId && s.subject===data.subject && Number(s.round)===Number(data.round));
    if(existing){
      Object.assign(existing, data);
      existing.id = existing.id;
    }else{
      state.stats.push(data);
    }

    state.stats = state.stats.filter((s, idx, arr)=>{
      const same = arr.findIndex(x=>x.typeId===s.typeId && x.subject===s.subject && Number(x.round)===Number(s.round));
      return same === idx;
    });

    await saveStateToServer(false);
    updateDetail();
    renderAllCharts();
    renderUniversityGroups();
    renderPctAlert();
  });

  /* ============================
   *  ë‹¨ì› ì¶”ê°€(ì˜)
   * ============================ */
  $("addUnitBtn").addEventListener("click", async ()=>{
    if(!isAdmin(currentUser)) return;
    if(!selectedTypeId || selectedRound==null) return alert("ì¢…ë¥˜/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");

    const unit = $("unitName").value.trim();
    const scoreRaw = $("unitScore").value.trim();
    const maxRaw = $("unitMax").value.trim();

    if(!unit) return alert("ë‹¨ì›ëª…ì„ ì…ë ¥í•´ì¤˜.");
    const score = Number(scoreRaw);
    if(!Number.isFinite(score)) return alert("ë‹¨ì› ì ìˆ˜ëŠ” ìˆ«ìì•¼.");

    const maxScore = (maxRaw==="") ? null : Number(maxRaw);
    state.units.push({
      id: uid(),
      typeId: selectedTypeId,
      subject: selectedSubject,
      round: Number(selectedRound),
      unit,
      score,
      maxScore: (maxScore!=null && Number.isFinite(maxScore)) ? maxScore : null,
      updatedAt: Date.now()
    });

    await saveStateToServer(false);

    $("unitName").value="";
    $("unitScore").value="";
    $("unitMax").value="";
    updateDetail();
    renderAllCharts();
  });

  /* ============================
   *  ìƒì„¸ í‘œì‹œ
   * ============================ */
  function updateDetail(){
    const my = getMyScoreDoc();
    $("myScoreLabel").textContent = my ? String(my.score) : "-";

    let extra = "";
    if(my){
      if(selectedSubject==="ì˜ì–´" || selectedSubject==="í•œêµ­ì‚¬"){
        extra = ` / ë“±ê¸‰: ${my.grade ?? "-"}`;
      }else{
        extra = ` / ë°±ë¶„ìœ„: ${(my.percentile!=null)? my.percentile : "-"}`;
      }
    }
    $("myExtraLabel").textContent = extra;

    const st = getStatDoc();
    $("avgLabel").textContent = (st && st.avg!=null) ? String(st.avg) : "-";

    const ud = getUnitDocs();
    const tb = $("unitTable");
    tb.innerHTML = "";
    if(ud.length===0){
      tb.innerHTML = `<tr><td colspan="3" class="muted">ë‹¨ì› ë°ì´í„° ì—†ìŒ(ì˜ê°€ ê´€ë¦¬ì—ì„œ ì¶”ê°€)</td></tr>`;
    }else{
      ud.forEach(x=>{
        tb.innerHTML += `<tr><td>${escapeHtml(x.unit)}</td><td>${x.score ?? "-"}</td><td>${x.maxScore ?? "-"}</td></tr>`;
      });
    }
  }

  /* ============================
   *  ê·¸ë˜í”„
   * ============================ */
  function renderChart1(){
    const rows = state.scores
      .filter(s => s.typeId===selectedTypeId && s.subject===selectedSubject)
      .map(s => ({ r:Number(s.round), v:Number(s.score) }))
      .filter(x => Number.isFinite(x.r) && Number.isFinite(x.v))
      .sort((a,b)=>a.r-b.r);

    const labels = rows.map(x=>`${x.r}íšŒ`);
    const values = rows.map(x=>x.v);

    c1 = new Chart($("chart1").getContext("2d"),{
      type:"line",
      data:{labels,datasets:[{label:`${selectedSubject} ì ìˆ˜`,data:values,fill:false}]},
      options:{responsive:true,scales:{y:{beginAtZero:true,max:100}}}
    });
  }

  function renderChart2(){
    const labels = state.types.map(t=>t.name);
    const values = state.types.map(t=>{
      const nums = state.scores
        .filter(s=>s.typeId===t.id && s.subject===selectedSubject)
        .map(s=>Number(s.score))
        .filter(v=>Number.isFinite(v));
      if(nums.length===0) return null;
      return nums.reduce((a,b)=>a+b,0)/nums.length;
    });

    c2 = new Chart($("chart2").getContext("2d"),{
      type:"bar",
      data:{labels,datasets:[{label:`${selectedSubject} ì¢…ë¥˜ë³„ í‰ê· `,data:values}]},
      options:{responsive:true,scales:{y:{beginAtZero:true,max:100}}}
    });
  }

  function renderChart3(){
    const noteEl = $("chart3Note");
    noteEl.textContent = "";

    if(!selectedTypeId || selectedRound==null){
      c3 = new Chart($("chart3").getContext("2d"),{ type:"bar", data:{labels:[],datasets:[{label:"",data:[]}]}, options:{responsive:true}});
      noteEl.textContent = "ì„ íƒì´ í•„ìš”í•´ìš”.";
      return;
    }

    const my = getMyScoreDoc();
    if(!my || !Number.isFinite(Number(my.score))){
      c3 = new Chart($("chart3").getContext("2d"),{ type:"bar", data:{labels:[],datasets:[{label:"",data:[]}]}, options:{responsive:true}});
      noteEl.textContent = "ë‚´ ì ìˆ˜ë¥¼ ì €ì¥í•˜ë©´ í‘œì‹œë¼ìš”.";
      return;
    }

    const needSubjects = ["êµ­ì–´","ìˆ˜í•™","í™”í•™1","ìƒëª…ê³¼í•™1"];
    const pctMap = {};
    let usedEstimate = false;

    for(const subj of needSubjects){
      let pct = null;
      if(subj === selectedSubject){
        pct = getCurrentPercentile(subj);
      }else{
        pct = getAvgPercentileOfSubject(subj);
      }
      if(pct==null){
        const c = getCurrentPercentile(subj);
        if(c!=null) pct = c;
      }
      if(pct==null){
        const sdoc = state.scores.find(s=>s.typeId===selectedTypeId && s.subject===subj && Number(s.round)===Number(selectedRound));
        const st = state.stats.find(x=>x.typeId===selectedTypeId && x.subject===subj && Number(x.round)===Number(selectedRound));
        if(sdoc && st){
          const est = estimatePercentileFromCuts(subj, Number(sdoc.score), st);
          if(est.ok){
            pct = est.pct;
            usedEstimate = true;
          }
        }
      }
      if(pct==null){
        c3 = new Chart($("chart3").getContext("2d"),{ type:"bar", data:{labels:[],datasets:[{label:"",data:[]}]}, options:{responsive:true}});
        noteEl.textContent = `ê·¸ë˜í”„3 ê³„ì‚° ë¶ˆê°€: ${subj} ë°±ë¶„ìœ„ê°€ ë¶€ì¡±í•´ìš”(ì»· 2ê°œ ì´ìƒ í•„ìš”).`;
        return;
      }
      pctMap[subj] = pct;
    }

    const engDoc = state.scores.find(s=>s.subject==="ì˜ì–´") ?? null;
    const hisDoc = state.scores.find(s=>s.subject==="í•œêµ­ì‚¬") ?? null;
    const engGrade = Number(engDoc?.grade);
    const hisGrade = Number(hisDoc?.grade);
    if(!Number.isFinite(engGrade) || !Number.isFinite(hisGrade)){
      c3 = new Chart($("chart3").getContext("2d"),{ type:"bar", data:{labels:[],datasets:[{label:"",data:[]}]}, options:{responsive:true}});
      noteEl.textContent = "ê·¸ë˜í”„3 ê³„ì‚° ë¶ˆê°€: ì˜ì–´/í•œêµ­ì‚¬ ë“±ê¸‰ ë°ì´í„°ê°€ í•„ìš”í•´ìš”.";
      return;
    }

    const col = calcCollegeScoreSnuJigyunV1({
      korPct: pctMap["êµ­ì–´"],
      mathPct: pctMap["ìˆ˜í•™"],
      chemPct: pctMap["í™”í•™1"],
      bioPct: pctMap["ìƒëª…ê³¼í•™1"],
      engGrade, hisGrade
    });

    if(!col.ok){
      c3 = new Chart($("chart3").getContext("2d"),{ type:"bar", data:{labels:[],datasets:[{label:"",data:[]}]}, options:{responsive:true}});
      noteEl.textContent = "ê·¸ë˜í”„3 ê³„ì‚° ë¶ˆê°€: ëŒ€í•™ì ìˆ˜ ê³„ì‚°ì— í•„ìš”í•œ ê°’ì´ ë¶€ì¡±í•´ìš”.";
      return;
    }

    const myScore = Number(my.score);
    const cuts = state.univ.snuJigyun;
    const myCollegeScore = col.collegeScore;

    const bars = cuts.map(u=>{
      const diff = myCollegeScore - u.cutCollegeScore;
      const mockNeed = myScore - diff*0.5; // v5 ì„ì‹œ í™˜ì‚°(ë‚˜ì¤‘ì— ì—­ì‚° ì—”ì§„ìœ¼ë¡œ êµì²´)
      return { label: `${u.major}`, v: mockNeed, diff };
    });

    const myBar = { label: "ë‚´ ì ìˆ˜", v: myScore, isMe:true, diff:0 };

    bars.sort((a,b)=>a.v-b.v);
    const smaller = bars.filter(b=>b.v < myScore).slice(-3);
    const bigger  = bars.filter(b=>b.v > myScore).slice(0,3);

    const finalBars = [...smaller, myBar, ...bigger].sort((a,b)=>a.v-b.v);

    const labels = finalBars.map(b=>b.label);
    const values = finalBars.map(b=>round1(b.v));

    c3 = new Chart($("chart3").getContext("2d"),{
      type:"bar",
      data:{labels,datasets:[{label:`${selectedSubject} ì ìˆ˜ ë¹„êµ`,data:values}]},
      options:{responsive:true,scales:{y:{beginAtZero:true,max:100}}}
    });

    let note = `ë‚´ ëŒ€í•™ì ìˆ˜(ì„œìš¸ëŒ€ ì§€ê·  v1): ${round1(myCollegeScore)} / (ê·¸ë˜í”„3ì€ v5 ì„ì‹œ í™˜ì‚° ëª¨ë¸)`;
    if(usedEstimate) note += " Â· ì¼ë¶€ ê³¼ëª©ì€ ì»· ê¸°ë°˜ ì¶”ì • ë°±ë¶„ìœ„ ì‚¬ìš©";
    noteEl.textContent = note;
  }

  function renderChart4(){
    const ud = getUnitDocs();
    const labels = ud.map(x=>x.unit);
    const values = ud.map(x=>Number(x.score));

    c4 = new Chart($("chart4").getContext("2d"),{
      type:"bar",
      data:{labels,datasets:[{label:`ë‹¨ì›ë³„ ${selectedSubject}`,data:values}]},
      options:{responsive:true,scales:{y:{beginAtZero:true,max:100}}}
    });
  }

  function renderAllCharts(){
    destroyCharts();
    if(!selectedTypeId) return;
    renderChart1();
    renderChart2();
    renderChart3();
    renderChart4();
  }

  /* ============================
   *  ë°±ë¶„ìœ„ ê´€ë ¨ ì•Œë¦¼
   * ============================ */
  function renderPctAlert(){
    if(!currentUser) return;
    const el = $("pctAlert");
    let msgs = [];

    if(selectedSubject==="ì˜ì–´" || selectedSubject==="í•œêµ­ì‚¬"){
      msgs.push("â€» ì˜ì–´/í•œêµ­ì‚¬ëŠ” ë°±ë¶„ìœ„ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }else{
      const my = getMyScoreDoc();
      if(my && my.percentile==null){
        const st = getStatDoc();
        const score = Number(my.score);
        const est = estimatePercentileFromCuts(selectedSubject, score, st);
        if(!st){
          msgs.push("â€» ë“±ê¸‰ì»·ì´ ì—†ì–´ ë°±ë¶„ìœ„(ì¶”ì •) ê³„ì‚°ì´ ë¶ˆê°€ëŠ¥í•  ìˆ˜ ìˆì–´ìš”.");
        }else if(!est.ok){
          msgs.push("â€» ë“±ê¸‰ì»·ì´ ë¶€ì¡±(2ê°œ ë¯¸ë§Œ)í•˜ë©´ ë°±ë¶„ìœ„(ì¶”ì •) ê³„ì‚°ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }else{
          msgs.push("â€» ë“±ê¸‰ì»·ì„ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì • ë°±ë¶„ìœ„ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.");
        }
      }
    }
    el.textContent = msgs.join(" ");
  }

  /* ============================
   *  ëŒ€í•™ ì¶”ì²œ(ì¹´ë“œ)
   * ============================ */
  function renderUniversityGroups(){
    const wrap = $("univGroups");
    const note = $("univNote");
    wrap.innerHTML = "";
    note.textContent = "";

    if(!currentUser) return;

    const needSubjects = ["êµ­ì–´","ìˆ˜í•™","í™”í•™1","ìƒëª…ê³¼í•™1"];
    const pctMap = {};
    let usedEstimate = false;

    for(const subj of needSubjects){
      let pct = null;
      if(subj === selectedSubject){
        pct = getCurrentPercentile(subj);
      }else{
        pct = getAvgPercentileOfSubject(subj);
      }
      if(pct==null){
        const c = getCurrentPercentile(subj);
        if(c!=null) pct = c;
      }
      if(pct==null){
        const sdoc = state.scores.find(s=>s.typeId===selectedTypeId && s.subject===subj && Number(s.round)===Number(selectedRound));
        const st = state.stats.find(x=>x.typeId===selectedTypeId && x.subject===subj && Number(x.round)===Number(selectedRound));
        if(sdoc && st){
          const est = estimatePercentileFromCuts(subj, Number(sdoc.score), st);
          if(est.ok){
            pct = est.pct;
            usedEstimate = true;
          }
        }
      }
      if(pct==null){
        wrap.innerHTML = `<div class="muted">ëŒ€í•™ì¶”ì²œ ê³„ì‚° ë¶ˆê°€: ${subj} ë°±ë¶„ìœ„ê°€ ë¶€ì¡±í•´ìš”(ì»· 2ê°œ ì´ìƒ í•„ìš”).</div>`;
        note.textContent = usedEstimate ? "â€» ì¼ë¶€ ê³¼ëª©ì€ ì»· ê¸°ë°˜ ì¶”ì • ë°±ë¶„ìœ„ ì‚¬ìš©" : "";
        return;
      }
      pctMap[subj] = pct;
    }

    const engDoc = state.scores.find(s=>s.subject==="ì˜ì–´") ?? null;
    const hisDoc = state.scores.find(s=>s.subject==="í•œêµ­ì‚¬") ?? null;
    const engGrade = Number(engDoc?.grade);
    const hisGrade = Number(hisDoc?.grade);
    if(!Number.isFinite(engGrade) || !Number.isFinite(hisGrade)){
      wrap.innerHTML = `<div class="muted">ëŒ€í•™ì¶”ì²œ ê³„ì‚° ë¶ˆê°€: ì˜ì–´/í•œêµ­ì‚¬ ë“±ê¸‰ ë°ì´í„°ê°€ í•„ìš”í•´ìš”.</div>`;
      return;
    }

    const col = calcCollegeScoreSnuJigyunV1({
      korPct: pctMap["êµ­ì–´"],
      mathPct: pctMap["ìˆ˜í•™"],
      chemPct: pctMap["í™”í•™1"],
      bioPct: pctMap["ìƒëª…ê³¼í•™1"],
      engGrade, hisGrade
    });

    if(!col.ok){
      wrap.innerHTML = `<div class="muted">ëŒ€í•™ì¶”ì²œ ê³„ì‚° ë¶ˆê°€: ëŒ€í•™ì ìˆ˜ ê³„ì‚° ê°’ì´ ë¶€ì¡±í•´ìš”.</div>`;
      return;
    }

    const myCollegeScore = col.collegeScore;

    const items = state.univ.snuJigyun.map(u=>{
      const diff = Math.round((myCollegeScore - u.cutCollegeScore)*100)/100;
      const cls = classify(diff);
      return { ...u, myCollegeScore, diff, cls };
    });

    const groups = ["ì•ˆì •","ì ì •","ì†Œì‹ ","ìƒí–¥"];
    const groupIcon = { "ì•ˆì •":"ğŸ›¡ï¸", "ì ì •":"âœ…", "ì†Œì‹ ":"ğŸ§­", "ìƒí–¥":"â¬†ï¸" };

    const html = groups.map(g=>{
      const list = items
        .filter(x=>x.cls===g)
        .sort((a,b)=>b.cutCollegeScore-a.cutCollegeScore)
        .slice(0,6);

      const tagClass = (g==="ì•ˆì •")?"good":(g==="ì ì •")?"neutral":(g==="ì†Œì‹ ")?"warn":"bad";

      return `
        <div class="card" style="margin-top:10px">
          <div class="t">${groupIcon[g]} ${g} <span class="muted">(ìµœëŒ€ 6ê°œ)</span></div>
          ${list.length===0 ? `<div class="muted" style="margin-top:6px">í•´ë‹¹ ì—†ìŒ</div>` : `
            <div class="grid2" style="margin-top:10px">
              ${list.map(u=>`
                <div class="card">
                  <div class="card-row">
                    <div>
                      <div class="t">${escapeHtml(u.school)}</div>
                      <div class="muted">${escapeHtml(u.track)}</div>
                    </div>
                    <div class="right tag ${tagClass}">${groupIcon[g]} ${g}</div>
                  </div>

                  <div class="hr"></div>

                  <div class="card-row">
                    <div class="logo-circle">S</div>
                    <div>
                      <div class="t">${escapeHtml(u.major)}</div>
                      <div class="muted">ëŒ€í•™ì ìˆ˜ â‰¥ <b>${round1(u.cutCollegeScore)}</b></div>
                    </div>
                  </div>

                  <div class="muted" style="margin-top:8px">
                    ë‚´ ëŒ€í•™ì ìˆ˜: <b>${round1(myCollegeScore)}</b> /
                    diff: <b>${round1(u.diff)}</b>
                  </div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;
    }).join("");

    wrap.innerHTML = html;
    note.textContent = usedEstimate ? "â€» ì¼ë¶€ ê³¼ëª©ì€ ì»· ê¸°ë°˜ ì¶”ì • ë°±ë¶„ìœ„ ì‚¬ìš©" : "";
  }

  /* ============================
   *  ëª©í‘œ ì‹œìŠ¤í…œ(ì˜ ì„¤ì • / ì¹˜ ì—´ëŒ)
   * ============================ */
  function renderGoalSection(){
    if(!currentUser) return;

    show($("goalSection"), roleGE(currentUser.grade, "ì¹˜"));
    show($("goalAdmin"), isAdmin(currentUser));

    if(!state.goal){
      $("goalSummary").textContent = "ëª©í‘œ ë¯¸ì„¤ì •";
    }else{
      $("goalSummary").innerHTML = `
        <b>${escapeHtml(state.goal.school)}</b> / <b>${escapeHtml(state.goal.major)}</b><br/>
        <span class="muted">ëª©í‘œ ëŒ€í•™ì ìˆ˜: <b>â‰¥ (í•´ë‹¹ í•™ê³¼ ì»·)</b></span>
      `;
    }

    if(isAdmin(currentUser)){
      const schoolSel = $("goalSchool");
      const majorSel = $("goalMajor");
      schoolSel.innerHTML = `<option value="ì„œìš¸ëŒ€í•™êµ(ì§€ê· )">ì„œìš¸ëŒ€í•™êµ(ì§€ê· )</option>`;
      const majors = state.univ.snuJigyun.map(x=>x.major);
      majorSel.innerHTML = majors.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");

      if(state.goal?.school) schoolSel.value = state.goal.school;
      if(state.goal?.major) majorSel.value = state.goal.major;

      $("toggleGoalEditorBtn").onclick = ()=>{
        $("goalEditor").classList.toggle("hidden");
      };

      $("saveGoalBtn").onclick = async ()=>{
        state.goal = { school: schoolSel.value, major: majorSel.value, updatedAt: Date.now() };
        await saveStateToServer(false);
        renderGoalSection();
      };

      $("deleteGoalBtn").onclick = async ()=>{
        if(!confirm("ëª©í‘œë¥¼ ì‚­ì œí• ê¹Œ?")) return;
        state.goal = null;
        await saveStateToServer(false);
        renderGoalSection();
      };
    }
  }

  /* ============================
   *  ê´€ë¦¬(ì˜)
   * ============================ */
  $("manageTab").addEventListener("click", ()=>{
    if(!isAdmin(currentUser)) return;
    $("manageSection").classList.toggle("hidden");
    renderManageAll();
    $("manageSection").scrollIntoView({behavior:"smooth", block:"start"});
  });

  function renderManageAll(){
    renderTypeList();
    renderUserList();
    renderLogs();
    renderUnivAdminList();
    renderPenaltyTables();
  }

  function renderTypeList(){
    const wrap = $("typeList");
    if(state.types.length===0){ wrap.textContent="ë“±ë¡ëœ ì¢…ë¥˜ ì—†ìŒ"; return; }

    wrap.innerHTML = state.types.map(t=>`
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0;">
        <div>â€¢ <b>${escapeHtml(t.name)}</b></div>
        <button class="danger" type="button" data-deltype="${t.id}">ì‚­ì œ</button>
      </div>
    `).join("");

    wrap.querySelectorAll("button[data-deltype]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-deltype");
        const has = state.scores.some(s=>s.typeId===id) || state.rounds.some(r=>r.typeId===id) || state.stats.some(s=>s.typeId===id) || state.units.some(u=>u.typeId===id);
        if(has) return alert("ì´ ì¢…ë¥˜ ë°ì´í„°ê°€ ìˆì–´ì„œ ì‚­ì œ ë¶ˆê°€(ê´€ë ¨ ë°ì´í„° ë¨¼ì € ì‚­ì œí•´ì•¼ í•¨)");
        state.types = state.types.filter(x=>x.id!==id);
        await saveStateToServer(false);
        renderTypeSelect();
        renderTypeList();
      });
    });
  }

  $("addTypeBtn").addEventListener("click", async ()=>{
    if(!isAdmin(currentUser)) return;
    const name = $("newTypeInput").value.trim();
    if(!name) return alert("ì¢…ë¥˜ ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
    if(state.types.some(t=>t.name===name)) return alert("ì´ë¯¸ ìˆëŠ” ì¢…ë¥˜ì•¼.");
    state.types.push({ id: uid(), name, createdAt: Date.now() });
    await saveStateToServer(false);
    $("newTypeInput").value="";
    renderTypeSelect();
    renderTypeList();
  });

  $("addUserBtn").addEventListener("click", async ()=>{
    if(!isAdmin(currentUser)) return;
    const name = $("newUserName").value.trim();
    const pw = $("newPw").value.trim();
    const grade = $("newGrade").value;
    if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
    if(!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");

    const pwHash = await sha256(pw);
    state.users.push({ id: uid(), name, grade, pwHash, createdAt: Date.now() });
    await saveStateToServer(false);
    $("newUserName").value="";
    $("newPw").value="";
    renderUserList();
  });

  function renderUserList(){
    const wrap = $("userList");
    wrap.innerHTML = "";
    state.users.forEach(u=>{
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="t">${escapeHtml(u.name)}</div>
        <div class="d">ë“±ê¸‰: <b>${escapeHtml(ROLE_EMOJI[u.grade]??"")}${escapeHtml(u.grade)}</b></div>
        <button class="danger" type="button" data-deluser="${u.id}" style="margin-top:8px">ì‚­ì œ</button>
      `;
      wrap.appendChild(div);
    });

    wrap.querySelectorAll("button[data-deluser]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-deluser");
        if(state.users.length===1) return alert("ìµœì†Œ 1ëª…(ê´€ë¦¬ì)ì€ ë‚¨ê²¨ì•¼ í•´.");
        state.users = state.users.filter(u=>u.id!==id);
        await saveStateToServer(false);
        renderUserList();
      });
    });
  }

  function renderLogs(){
    const box = $("loginRecords");
    if(state.logs.length===0){ box.textContent="ê¸°ë¡ ì—†ìŒ"; return; }
    box.innerHTML = state.logs.slice().reverse().map(l=>`â€¢ [${escapeHtml(l.time)}] ${escapeHtml(l.name)} (${escapeHtml(ROLE_EMOJI[l.grade]??"")}${escapeHtml(l.grade)})`).join("<br/>");
  }

  $("clearLogsBtn").addEventListener("click", async ()=>{
    if(!isAdmin(currentUser)) return;
    state.logs = [];
    await saveStateToServer(false);
    renderLogs();
  });

  function renderUnivAdminList(){
    const box = $("univAdminList");
    const list = state.univ.snuJigyun;
    box.innerHTML = `
      <table>
        <thead><tr><th>ê³„ì—´</th><th>í•™êµ</th><th>í•™ê³¼</th><th>ì»·(ëŒ€í•™ì ìˆ˜)</th></tr></thead>
        <tbody>
          ${list.map(u=>`
            <tr>
              <td>${escapeHtml(u.track)}</td>
              <td>${escapeHtml(u.school)}</td>
              <td>${escapeHtml(u.major)}</td>
              <td><b>${round1(u.cutCollegeScore)}</b></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function renderPenaltyTables(){
    const e = $("engPenaltyTable");
    const h = $("hisPenaltyTable");
    e.innerHTML = "";
    h.innerHTML = "";
    for(let g=1; g<=9; g++){
      e.innerHTML += `<tr><td>${g}</td><td>${ENG_PENALTY[g]}</td></tr>`;
      h.innerHTML += `<tr><td>${g}</td><td>${HIS_PENALTY[g]}</td></tr>`;
    }

    const tbody = $("snuCutsTable");
    tbody.innerHTML = "";
    state.univ.snuJigyun
      .slice()
      .sort((a,b)=>b.cutCollegeScore-a.cutCollegeScore)
      .forEach(u=>{
        tbody.innerHTML += `
          <tr>
            <td>${escapeHtml(u.track)}</td>
            <td>${escapeHtml(u.school)}</td>
            <td>${escapeHtml(u.major)}</td>
            <td><b>${round1(u.cutCollegeScore)}</b></td>
          </tr>
        `;
      });
  }

  /* ============================
   *  ì´ˆê¸° ì‹¤í–‰
   * ============================ */
  await loadStateFromServer();
  startRealtimeSync();
  boot();

</script>
</body>
</html>

