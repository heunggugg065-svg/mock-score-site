<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScoreBoard v4</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#111827,#4f46e5);margin:0;padding:20px}
    .container{max-width:1100px;margin:auto;background:#fff;padding:22px 22px 28px;border-radius:18px;box-shadow:0 15px 40px rgba(0,0,0,.25);position:relative}
    h1{margin:6px 0 6px;text-align:center}
    .subh{margin:0 0 10px;text-align:center;color:#4b5563;font-size:13px}
    .top-right{position:absolute;top:14px;right:16px;display:flex;gap:10px;align-items:center}
    .link-btn{font-size:12px;color:#4f46e5;cursor:pointer;user-select:none;background:none;border:none}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin:6px 0}
    .section{margin-top:16px;padding:14px;border:1px solid #eef2ff;border-radius:14px;background:#fafbff}
    .section h3{margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{padding:10px;margin:6px 0;box-sizing:border-box;border-radius:10px;border:1px solid #d1d5db}
    input,select{width:100%}
    .row > *{flex:1 1 180px}
    button{background:#4f46e5;color:#fff;border:none;cursor:pointer;font-weight:900}
    button:hover{background:#4338ca}
    .ghost{background:#111827}
    .ghost:hover{background:#0b1220}
    .danger{background:#dc2626}
    .danger:hover{background:#b91c1c}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .muted{color:#6b7280;font-size:12px}
    .hidden{display:none !important}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .grid4{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width: 900px){.grid2,.grid4{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:12px}
    .card .t{font-weight:900;margin-bottom:4px}
    .card .d{font-size:13px;color:#374151}
    canvas{margin-top:10px}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap}
    .btnbar button{width:auto;padding:8px 12px;border-radius:999px}
    .btnbar .active{outline:3px solid #c7d2fe}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:center}
    th{background:#f3f4f6}
    .mini{font-size:12px}

    /* í•™ë…„ë„ íƒ­ */
    .year-tabs{display:flex;gap:8px;align-items:flex-end;margin:10px 0 0}
    .year-tab{
      border:1px solid #e5e7eb;background:#f3f4f6;color:#111827;
      padding:8px 14px;border-bottom:none;border-top-left-radius:12px;border-top-right-radius:12px;
      cursor:pointer;font-weight:900;
    }
    .year-tab.active{background:#fff;color:#4f46e5;border-color:#c7d2fe}
    .year-tab.locked{opacity:.45;cursor:not-allowed}
    .year-bar{border:1px solid #c7d2fe;border-radius:14px;background:#fff;padding:10px 12px;margin-top:-1px}

    footer{margin-top:22px;text-align:center;color:#6b7280;font-size:12px}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:12px;padding:10px;margin-top:10px;font-size:12px}
  </style>
</head>

<body>
  <div class="container">
    <div class="top-right">
      <button id="manageTab" class="link-btn hidden" type="button">ê´€ë¦¬</button>
      <button id="logoutBtn" class="link-btn hidden" type="button">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <h1>ğŸ“Š ScoreBoard</h1>
    <div id="helloLine" class="subh hidden"></div>
    <div id="roleBadge" class="badge hidden"></div>
    <div id="serverHint" class="warn hidden"></div>

    <!-- ìµœì´ˆ ê´€ë¦¬ì ì„¤ì •(ìœ ì €ê°€ í•œ ë²ˆë§Œ ì…ë ¥) -->
    <div id="setupSection" class="section hidden">
      <h3>ğŸ§© ìµœì´ˆ 1íšŒ: ê´€ë¦¬ì(ì˜) ìƒì„±</h3>
      <div class="muted">* ë¹„ë°€ë²ˆí˜¸ëŠ” ì €ì¥ë  ë•Œ í•´ì‹œë¡œ ì €ì¥ë¼ì„œ í™”ë©´/ëª©ë¡ì— ì•ˆ ë³´ì—¬ìš”.</div>
      <div class="row">
        <input id="setupName" placeholder="ê´€ë¦¬ì ì´ë¦„ (ì˜ˆ: ë°•ì¤€ì„œ)" />
        <input id="setupPw" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />
        <button id="setupBtn" class="ghost" type="button">ê´€ë¦¬ì ìƒì„±</button>
      </div>
    </div>

    <!-- ë¡œê·¸ì¸ -->
    <div id="loginSection" class="section hidden">
      <h3>ğŸ” ë¡œê·¸ì¸</h3>
      <input id="pwInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      <button id="loginBtn" type="button">ë¡œê·¸ì¸</button>
      <div class="muted">â€» ë¹„ë°€ë²ˆí˜¸ëŠ” í™”ë©´ì— í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    </div>

    <!-- í•™ë…„ë„ íƒ­ -->
    <div id="yearWrap" class="hidden">
      <div class="year-tabs">
        <button id="tab2026" class="year-tab" type="button" data-year="2026">2026í•™ë…„ë„</button>
        <button id="tab2027" class="year-tab" type="button" data-year="2027">2027í•™ë…„ë„</button>
      </div>
      <div class="year-bar">
        <div class="row" style="align-items:center">
          <div style="flex:1 1 260px">
            <span class="pill">í˜„ì¬ í•™ë…„ë„: <b id="currentYearLabel">2027</b></span>
            <span class="pill">í˜„ì¬ ë“±ê¸‰: <b id="currentGradeLabel">-</b></span>
          </div>
          <div style="flex:2 1 520px" class="muted">
            * í•œ/ì•½/ìˆ˜ëŠ” 2027í•™ë…„ë„ë§Œ ì—´ëŒ ê°€ëŠ¥. (ì˜/ì¹˜ëŠ” 2026/2027 ëª¨ë‘ ê°€ëŠ¥)
          </div>
        </div>
      </div>
    </div>

    <!-- ì„ íƒ -->
    <div id="pickSection" class="section hidden">
      <h3>ğŸ§­ ì„ íƒ</h3>

      <div class="row">
        <div style="flex:2 1 360px">
          <div class="muted">ì¢…ë¥˜ ì„ íƒ</div>
          <select id="typeSelect"></select>
        </div>
        <div style="flex:3 1 420px">
          <div class="muted">í˜„ì¬ ì„ íƒ</div>
          <div class="pill" id="currentPick">-</div>
        </div>
      </div>

      <div class="muted" style="margin-top:6px">ê³¼ëª© ì„ íƒ(ë²„íŠ¼)</div>
      <div id="subjectButtons" class="btnbar"></div>

      <div class="muted" style="margin-top:10px">íšŒì°¨ ì„ íƒ(ë²„íŠ¼)</div>
      <div id="roundButtons" class="btnbar"></div>
    </div>

    <!-- íšŒì°¨ ìƒì„±/ì‚­ì œ(ì˜ ì „ìš©) -->
    <div id="roundCreateSection" class="section hidden">
      <h3>â• íšŒì°¨ ìƒì„± (ì˜ ì „ìš©)</h3>
      <div class="muted">* (í•™ë…„ë„/ì¢…ë¥˜/ê³¼ëª©)ì— íšŒì°¨ë¥¼ ì¶”ê°€í•˜ë©´ ë°”ë¡œ íšŒì°¨ ë²„íŠ¼ì´ ìƒê²¨ìš”.</div>
      <div class="row">
        <input id="newRoundInput" type="number" placeholder="ì¶”ê°€í•  íšŒì°¨ (ì˜ˆ: 1)" />
        <button id="addRoundBtn" class="ghost" type="button">íšŒì°¨ ì¶”ê°€</button>
        <button id="deleteRoundBtn" class="danger" type="button">ì„ íƒ íšŒì°¨ ì‚­ì œ</button>
      </div>
      <div class="muted">* ì‚­ì œí•˜ë©´ í•´ë‹¹ íšŒì°¨ì˜ ì ìˆ˜/í†µê³„/ë‹¨ì› ë°ì´í„°ê¹Œì§€ ê°™ì´ ì‚­ì œë©ë‹ˆë‹¤.</div>
    </div>

    <!-- ì ìˆ˜ ì…ë ¥(ì˜ë§Œ) -->
    <div id="scoreEditorSection" class="section hidden">
      <h3>âœï¸ ì ìˆ˜ ì…ë ¥ (ì˜ ì „ìš©)</h3>
      <div class="row">
        <input id="scoreInput" type="number" placeholder="ì ìˆ˜" />
        <input id="percentileInput" type="number" placeholder="ë°±ë¶„ìœ„(ì„ íƒ)" min="0" max="100" />
        <button id="saveScoreBtn" type="button">ì €ì¥/ì—…ë°ì´íŠ¸</button>
      </div>
      <div class="muted">* (í•™ë…„ë„/ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨) ì¡°í•©ì´ ì´ë¯¸ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ì €ì¥</div>
    </div>

    <!-- ê·¸ë˜í”„ 4ê°œ -->
    <div id="chartsSection" class="section hidden">
      <h3>ğŸ“ˆ ê·¸ë˜í”„</h3>
      <div class="grid4">
        <div class="card">
          <div class="t">ê·¸ë˜í”„ 1) ì„ íƒí•œ ì¢…ë¥˜ Â· ê³¼ëª©ì˜ íšŒì°¨ë³„ ê²½í–¥</div>
          <div class="d mini">X=íšŒì°¨, Y=ì ìˆ˜ (0~100)</div>
          <canvas id="chart1"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 2) ì¢…ë¥˜ë³„ í‰ê·  ë¹„êµ(ë§‰ëŒ€)</div>
          <div class="d mini">ì˜ˆ) ìƒëª…ê³¼í•™1 ì„ íƒ ì‹œ: í•™ë ¥í‰ê°€ í‰ê·  vs ì„œë°”ì´ë²Œ í‰ê· </div>
          <canvas id="chart2"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 3) í•´ë‹¹ ì‹œí—˜ì—ì„œ ë¹„êµ(í‰ê· /ë“±ê¸‰ì»·)</div>
          <div class="d mini">ì˜ê°€ ì…ë ¥í•œ í‰ê· /ì»· ê¸°ì¤€</div>
          <canvas id="chart3"></canvas>
        </div>

        <div class="card">
          <div class="t">ê·¸ë˜í”„ 4) ë‹¨ì›ë³„ ì ìˆ˜ ë¹„êµ</div>
          <div class="d mini">ì˜ê°€ ì…ë ¥í•œ ë‹¨ì› ì ìˆ˜</div>
          <canvas id="chart4"></canvas>
        </div>
      </div>
    </div>

    <!-- ìƒì„¸ -->
    <div id="detailSection" class="section hidden">
      <h3>ğŸ“Œ ì„ íƒ ìƒì„¸</h3>
      <div class="grid2">
        <div class="card">
          <div class="t">ë‚´ ì ìˆ˜(ì„ íƒ ì¡°í•©)</div>
          <div class="d">ì ìˆ˜: <b id="myScoreLabel">-</b> / ë°±ë¶„ìœ„: <b id="myPctLabel">-</b></div>
        </div>
        <div class="card">
          <div class="t">ì‹œí—˜ í†µê³„(ë‹¤ë¥¸ì‚¬ëŒ ë¹„êµìš©)</div>
          <div class="d">í‰ê· : <b id="avgLabel">-</b></div>
          <div class="muted">* ë“±ê¸‰ì»·ì€ ê·¸ë˜í”„3ì— ì„ ìœ¼ë¡œ í‘œì‹œ</div>
        </div>
      </div>

      <div class="section" style="background:#fff;margin-top:12px">
        <h3 style="margin:0 0 8px">ë‹¨ì›ë³„ ì ìˆ˜</h3>
        <table>
          <thead><tr><th>ë‹¨ì›</th><th>ì ìˆ˜</th><th>ë§Œì </th></tr></thead>
          <tbody id="unitTable"></tbody>
        </table>
      </div>

      <div class="section" style="background:#fff;margin-top:12px">
        <h3 style="margin:0 0 8px">ğŸ“ ëŒ€í•™ ì¶”ì²œ</h3>
        <div class="muted">* ë‚´ ë°±ë¶„ìœ„ ê¸°ì¤€ìœ¼ë¡œ ì•ˆì •/ì ì •/ìƒí–¥ ì¶”ì²œ (ê¸°ì¤€ì€ ë‚˜ì¤‘ì— ìˆ«ìë§Œ ë°”ê¾¸ë©´ ë¨)</div>
        <div id="univCards" class="grid2" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- ê´€ë¦¬(ì˜ ì „ìš©) -->
    <div id="manageSection" class="section hidden">
      <h3>ğŸ›  ê´€ë¦¬ (ì˜ ì „ìš©)</h3>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§© ì¢…ë¥˜ ê´€ë¦¬(í•™ë…„ë„ë³„)</h3>
        <div class="row">
          <input id="newTypeInput" placeholder="ìƒˆ ì¢…ë¥˜ ì´ë¦„ (ì˜ˆ: í•™ë ¥í‰ê°€, ì„œë°”ì´ë²Œ)" />
          <button id="addTypeBtn" class="ghost" type="button">ì¢…ë¥˜ ì¶”ê°€</button>
        </div>
        <div id="typeList" class="muted"></div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ‘¤ ì‚¬ìš©ì ë“±ë¡(ì´ë¦„+ë¹„ë°€ë²ˆí˜¸+ë“±ê¸‰)</h3>
        <div class="row">
          <input id="newUserName" placeholder="ì´ë¦„" />
          <input id="newPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
          <select id="newGrade">
            <option value="ì¹˜">ì¹˜</option>
            <option value="í•œ">í•œ</option>
            <option value="ì•½">ì•½</option>
            <option value="ìˆ˜">ìˆ˜</option>
            <option value="ì˜">ì˜</option>
          </select>
          <button id="addUserBtn" class="ghost" type="button">ì¶”ê°€</button>
        </div>
        <div class="muted">* ë¹„ë°€ë²ˆí˜¸ëŠ” í•´ì‹œë¡œ ì €ì¥ë˜ì–´ ëª©ë¡/ì½”ë“œì— í‘œì‹œë˜ì§€ ì•ŠìŒ</div>
        <div id="userList" style="margin-top:10px"></div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§¾ ë¡œê·¸ì¸ ê¸°ë¡(ì˜ë§Œ ì—´ëŒ)</h3>
        <div id="loginRecords" class="muted">ê¸°ë¡ ì—†ìŒ</div>
        <button id="clearLogsBtn" class="danger" type="button">ë¡œê·¸ì¸ ê¸°ë¡ ì „ì²´ ì‚­ì œ</button>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ“Š ì‹œí—˜ í†µê³„ ì…ë ¥(ê·¸ë˜í”„3)</h3>
        <div class="muted">í˜„ì¬ ì„ íƒ(í•™ë…„ë„/ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨)ì— ëŒ€í•´ í‰ê· /ë“±ê¸‰ì»· ì €ì¥</div>
        <div class="row">
          <input id="statAvg" type="number" placeholder="í‰ê· (ì˜ˆ: 78)" />
          <input id="cut1" type="number" placeholder="1ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut2" type="number" placeholder="2ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut3" type="number" placeholder="3ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <div class="row">
          <input id="cut4" type="number" placeholder="4ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut5" type="number" placeholder="5ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut6" type="number" placeholder="6ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <div class="row">
          <input id="cut7" type="number" placeholder="7ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut8" type="number" placeholder="8ë“±ê¸‰ì»·(ì„ íƒ)" />
          <input id="cut9" type="number" placeholder="9ë“±ê¸‰ì»·(ì„ íƒ)" />
        </div>
        <button id="saveStatsBtn" class="ghost" type="button">í†µê³„ ì €ì¥/ì—…ë°ì´íŠ¸</button>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§© ë‹¨ì› ì ìˆ˜ ì…ë ¥(ê·¸ë˜í”„4)</h3>
        <div class="muted">í˜„ì¬ ì„ íƒ(í•™ë…„ë„/ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨)ì— ë‹¨ì› ì ìˆ˜ ì¶”ê°€</div>
        <div class="row">
          <input id="unitName" placeholder="ë‹¨ì›ëª…(ì˜ˆ: ë¬¸í•™/ë¹„ë¬¸í•™, ë¯¸ì ë¶„-ìˆ˜ì—´)" />
          <input id="unitScore" type="number" placeholder="ì ìˆ˜" />
          <input id="unitMax" type="number" placeholder="ë§Œì (ì„ íƒ)" />
          <button id="addUnitBtn" class="ghost" type="button">ë‹¨ì› ì¶”ê°€</button>
        </div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ“ ëŒ€í•™ ë°ì´í„° ë„£ê¸°</h3>
        <div class="muted">í˜•ì‹: ë°±ë¶„ìœ„,í•™êµ,í•™ê³¼ â€” í•œ ì¤„ì— í•˜ë‚˜</div>
        <textarea id="univPaste" style="width:100%;height:140px;border-radius:12px;border:1px solid #d1d5db;padding:10px;margin-top:8px"
          placeholder="ì˜ˆì‹œ
96,ì„œìš¸ëŒ€,ì»´í“¨í„°ê³µí•™
92,ì—°ì„¸ëŒ€,ê²½ì˜
88,ì¤‘ì•™ëŒ€,í™”í•™"></textarea>
        <div class="row">
          <button id="importUnivBtn" class="ghost" type="button">ì €ì¥í•˜ê¸°</button>
          <button id="clearUnivBtn" class="danger" type="button">ì „ì²´ì‚­ì œ</button>
        </div>
      </div>

      <div class="section" style="background:#fff">
        <h3 style="margin:0 0 8px">ğŸ§¨ ì „ì²´ ì´ˆê¸°í™”(ì£¼ì˜)</h3>
        <div class="muted">ì„œë²„(Firestore)ì— ì €ì¥ëœ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤.</div>
        <button id="resetAllBtn" class="danger" type="button">ì „ì²´ ë°ì´í„° ì‚­ì œ</button>
      </div>
    </div>

    <footer>ScoreBoard v4</footer>
  </div>

  <script type="module">
    // ==========================================================
    // v4: Firebase / Firestore ì—°ê²°
    // ==========================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const APP_VERSION = 4;

    const firebaseConfig = {
      apiKey: "AIzaSyCuMFRksmpH0TuNqv3YoMa76DAAN4r3B84",
      authDomain: "scoreboard-d4bf9.firebaseapp.com",
      projectId: "scoreboard-d4bf9",
      storageBucket: "scoreboard-d4bf9.firebasestorage.app",
      messagingSenderId: "272482248722",
      appId: "1:272482248722:web:81147fe66081feb9da50cb",
      measurementId: "G-VC1922P5SV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ìƒíƒœ ë¬¸ì„œ 1ê°œë¡œ í†µì§¸ë¡œ ì €ì¥(ê°€ì¥ ë‹¨ìˆœ/ì•ˆì •)
    const STATE_REF = doc(db, "sb_state", "main");

    // ==========================================================
    // ê¸°ë³¸ ìƒìˆ˜/í—¬í¼
    // ==========================================================
    const SUBJECTS = ["êµ­ì–´","ìˆ˜í•™","ì˜ì–´","í™”í•™1","ìƒëª…ê³¼í•™1","í•œêµ­ì‚¬"];
    const gradeHierarchy = { "ì˜": 5, "ì¹˜": 4, "í•œ": 3, "ì•½": 2, "ìˆ˜": 1 };

    function canViewYear(grade, year){
      if(grade === "ì˜" || grade === "ì¹˜") return true;
      if(grade === "í•œ" || grade === "ì•½" || grade === "ìˆ˜") return year === "2027";
      return false;
    }

    const $ = (id)=>document.getElementById(id);
    const escapeHtml = (s)=>String(s??"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    function show(el, yes){ el.classList.toggle("hidden", !yes); }

    function uid(){
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    // SHA-256
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    // ==========================================================
    // ëŒ€í•™ ë°ì´í„°(í•˜ë“œì½”ë”©) + ì¶”ì²œ ë¶„ë¥˜ ê¸°ì¤€(ìˆ«ìë§Œ ë°”ê¾¸ë©´ ë¨)
    // ==========================================================
    // í˜•ì‹: { minPercentile, university, major }
    // (ë„ˆëŠ” ì—¬ê¸° ë°°ì—´ì— ì§ì ‘ ë„£ì–´ë„ ë˜ê³ , ê´€ë¦¬ì—ì„œ ë¶™ì—¬ë„£ê¸°ë¡œ ë„£ì–´ë„ ë¨)
    const UNIVERSITY_DATA_DEFAULT = [
      // { minPercentile: 96, university: "ì„œìš¸ëŒ€", major: "ì»´í“¨í„°ê³µí•™" },
      // { minPercentile: 92, university: "ì—°ì„¸ëŒ€", major: "ê²½ì˜" },
      // { minPercentile: 88, university: "ì¤‘ì•™ëŒ€", major: "í™”í•™" },
    ];

    // ì¶”ì²œ ë¶„ë¥˜ ê¸°ì¤€(ë„ˆê°€ ë‚˜ì¤‘ì— ìˆ«ìë§Œ ë°”ê¾¸ë©´ ë¨)
    // diff = ë‚´ë°±ë¶„ìœ„ - í•„ìš”ë°±ë¶„ìœ„
    // ì•ˆì •: diff >= SAFE_DIFF
    // ì ì •: MATCH_LOW <= diff < SAFE_DIFF
    // ìƒí–¥: diff < MATCH_LOW
    const SAFE_DIFF = 4;
    const MATCH_LOW = 0;

    function classifyUniv(myPct, needPct){
      const diff = Number(myPct) - Number(needPct);
      if(diff >= SAFE_DIFF) return { label:"ì•ˆì •", key:"safe" };
      if(diff >= MATCH_LOW) return { label:"ì ì •", key:"fit" };
      return { label:"ìƒí–¥", key:"reach" };
    }

    // ==========================================================
    // ì„œë²„ ìƒíƒœ êµ¬ì¡°
    // ==========================================================
    function defaultState(){
      return {
        meta: { appVersion: APP_VERSION, updatedAt: Date.now() },
        users: [], // {id,name,grade,pwHash,createdAt}
        logs: [],  // {time,name,grade}
        // í•™ë…„ë„ë³„ ì¢…ë¥˜ë¥¼ ìœ ì§€(ë„ˆê°€ ì´ë¯¸ ì“°ê³  ìˆì–´ì„œ UI ìœ ì§€)
        types: { "2026": [], "2027": [] }, // {id,name,createdAt}
        rounds: [], // {id,year,typeId,subject,round,createdAt}  â† íšŒì°¨ ë²„íŠ¼ìš©
        scores: [], // {id,year,typeId,subject,round,score,percentile,updatedAt}
        stats:  [], // {id,year,typeId,subject,round,avg,cut1..cut9,updatedAt}
        units:  [], // {id,year,typeId,subject,round,unit,score,maxScore,updatedAt}
        // ëŒ€í•™ë°ì´í„°ëŠ” í•™ë…„ë„ êµ¬ë¶„ ì—†ì• ê³  í•˜ë‚˜ë¡œ
        univ: [] // {id,minPercentile,university,major,createdAt}
      };
    }

    // ==========================================================
    // v4 ì„œë²„ ì €ì¥ ë¡œì§
    // ==========================================================
    let state = defaultState();

    async function loadStateFromServer(){
      const hint = $("serverHint");
      try{
        const snap = await getDoc(STATE_REF);

        if(!snap.exists()){
          state = defaultState();
          // ê¸°ë³¸ ì¢…ë¥˜/ëŒ€í•™ ë°ì´í„°ë„ ì‚´ì§ ì„¸íŒ…
          seedDefaultsIfEmpty();
          await saveStateToServer();
          show(hint, true);
          hint.textContent = "ì„œë²„ì— ì²« ìƒíƒœë¥¼ ìƒì„±í–ˆì–´ìš”. (Firestore ì—°ê²° OK)";
          return;
        }

        const st = snap.data() || {};
        if(!st.users) st.users = [];
        if(!st.logs) st.logs = [];
        if(!st.types) st.types = { "2026": [], "2027": [] };
        if(!st.rounds) st.rounds = [];
        if(!st.scores) st.scores = [];
        if(!st.stats) st.stats = [];
        if(!st.units) st.units = [];
        if(!st.univ) st.univ = [];

        state = st;

        // í˜¹ì‹œ ê¸°ë³¸ëŒ€í•™ ë°ì´í„° ë„£ê³  ì‹œì‘í•˜ê³  ì‹¶ìœ¼ë©´(ì²˜ìŒ í•œë²ˆë§Œ)
        if(state.univ.length === 0 && UNIVERSITY_DATA_DEFAULT.length){
          for(const u of UNIVERSITY_DATA_DEFAULT){
            state.univ.push({ id: uid(), minPercentile: u.minPercentile, university: u.university, major: u.major, createdAt: Date.now() });
          }
          await saveStateToServer();
        }

        show(hint, false);
      }catch(e){
        console.error(e);
        show(hint, true);
        hint.textContent = "ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆì–´. (Firestore ê·œì¹™/ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ í™•ì¸)  â€” ì½˜ì†”(F12)ë„ í™•ì¸í•´ì¤˜.";
      }
    }

    async function saveStateToServer(){
      state.meta = state.meta || {};
      state.meta.appVersion = APP_VERSION;
      state.meta.updatedAt = Date.now();
      await setDoc(STATE_REF, state, { merge: true });
    }

    function seedDefaultsIfEmpty(){
      // ê¸°ë³¸ ì¢…ë¥˜ (ì²˜ìŒ 1íšŒë§Œ)
      if((state.types["2026"]||[]).length === 0){
        state.types["2026"] = [
          { id: uid(), name: "í•™ë ¥í‰ê°€", createdAt: Date.now() },
          { id: uid(), name: "ì„œë°”ì´ë²Œ", createdAt: Date.now() },
        ];
      }
      if((state.types["2027"]||[]).length === 0){
        state.types["2027"] = [
          { id: uid(), name: "í•™ë ¥í‰ê°€", createdAt: Date.now() },
          { id: uid(), name: "ì„œë°”ì´ë²Œ", createdAt: Date.now() },
        ];
      }
      // ëŒ€í•™ ê¸°ë³¸ê°’(ì›í•˜ë©´ ì£¼ì„ í’€ê³  ì‚¬ìš©)
      if(state.univ.length === 0 && UNIVERSITY_DATA_DEFAULT.length){
        for(const u of UNIVERSITY_DATA_DEFAULT){
          state.univ.push({ id: uid(), minPercentile: u.minPercentile, university: u.university, major: u.major, createdAt: Date.now() });
        }
      }
    }

    // ==========================================================
    // ì „ì—­ UI ìƒíƒœ
    // ==========================================================
    let currentUser = null; // {id,name,grade}
    let currentYear = "2027";

    let selectedTypeId = null;
    let selectedSubject = SUBJECTS[0];
    let selectedRound = null;

    let c1=null,c2=null,c3=null,c4=null;

    // ==========================================================
    // ë¶€íŒ…/ë¡œê·¸ì¸ UI
    // ==========================================================
    function setHello(){
      if(!currentUser) return;
      $("helloLine").textContent = `ì•ˆë…•í•˜ì„¸ìš”, ${currentUser.name}ë‹˜`;
    }

    function setBadges(){
      $("roleBadge").textContent = `í˜„ì¬ ë“±ê¸‰: ${currentUser.grade}`;
      $("currentGradeLabel").textContent = currentUser.grade;
      $("currentYearLabel").textContent = currentYear;
    }

    function applyYearTabs(){
      const can26 = canViewYear(currentUser.grade,"2026");
      const can27 = canViewYear(currentUser.grade,"2027");

      $("tab2026").classList.toggle("locked", !can26);
      $("tab2027").classList.toggle("locked", !can27);

      $("tab2026").classList.toggle("active", currentYear==="2026");
      $("tab2027").classList.toggle("active", currentYear==="2027");

      $("currentYearLabel").textContent = currentYear;
    }

    function boot(){
      const hasUsers = (state.users?.length || 0) > 0;

      show($("setupSection"), !hasUsers);
      show($("loginSection"), hasUsers);

      show($("yearWrap"), false);
      show($("pickSection"), false);
      show($("roundCreateSection"), false);
      show($("scoreEditorSection"), false);
      show($("chartsSection"), false);
      show($("detailSection"), false);

      show($("manageTab"), false);
      show($("manageSection"), false);
      show($("logoutBtn"), false);

      show($("roleBadge"), false);
      show($("helloLine"), false);

      if(hasUsers){
        $("pwInput").value = "";
      }
    }

    function destroyCharts(){
      if(c1) c1.destroy(); if(c2) c2.destroy(); if(c3) c3.destroy(); if(c4) c4.destroy();
      c1=c2=c3=c4=null;
    }

    async function addLog(name, grade){
      state.logs.push({ time: new Date().toLocaleString(), name, grade });
      await saveStateToServer();
    }

    async function loginWithPassword(pw){
      const hash = await sha256(pw);
      const user = state.users.find(u => u.pwHash === hash);
      if(!user) return null;
      return { id:user.id, name:user.name, grade:user.grade };
    }

    function afterLogin(){
      show($("loginSection"), false);
      show($("setupSection"), false);

      show($("yearWrap"), true);
      show($("pickSection"), true);
      show($("chartsSection"), true);
      show($("detailSection"), true);
      show($("logoutBtn"), true);

      show($("roleBadge"), true);
      show($("helloLine"), true);
      setHello();
      setBadges();

      const isAdmin = currentUser.grade === "ì˜";
      show($("manageTab"), isAdmin);
      show($("manageSection"), false);
      show($("scoreEditorSection"), isAdmin);
      show($("roundCreateSection"), isAdmin);

      if(!canViewYear(currentUser.grade, currentYear)){
        currentYear = "2027";
      }
      applyYearTabs();

      renderSubjectButtons();
      renderTypeSelect();
      updatePickLabel();
      renderRoundButtons();
      updateDetail();
      renderAllCharts();

      if(isAdmin) renderManageAll();
    }

    // ==========================================================
    // í•™ë…„ë„ íƒ­
    // ==========================================================
    function handleYearClick(year){
      if(!canViewYear(currentUser.grade, year)){
        alert("ì´ ë“±ê¸‰ì€ í•´ë‹¹ í•™ë…„ë„ ì—´ëŒ ê¶Œí•œì´ ì—†ì–´ìš”.");
        return;
      }
      if(currentYear === year) return;
      currentYear = year;

      selectedTypeId = null;
      selectedRound = null;

      destroyCharts();
      applyYearTabs();

      renderTypeSelect();
      updatePickLabel();
      renderRoundButtons();
      updateDetail();
      renderAllCharts();

      if(currentUser.grade === "ì˜"){
        renderManageAll();
      }
    }

    $("tab2026").addEventListener("click", ()=>handleYearClick("2026"));
    $("tab2027").addEventListener("click", ()=>handleYearClick("2027"));

    // ==========================================================
    // ì„ íƒ UI(ì¢…ë¥˜/ê³¼ëª©/íšŒì°¨)
    // ==========================================================
    function renderTypeSelect(){
      const sel = $("typeSelect");
      sel.innerHTML = "";

      const types = state.types[currentYear] || [];
      if(types.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "ì¢…ë¥˜ ì—†ìŒ(ì˜ê°€ ê´€ë¦¬ì—ì„œ ì¶”ê°€)";
        sel.appendChild(opt);
        sel.disabled = true;
        selectedTypeId = null;
        return;
      }

      sel.disabled = false;
      for(const t of types){
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      }

      if(!selectedTypeId || !types.some(t=>t.id===selectedTypeId)){
        selectedTypeId = sel.value;
      }else{
        sel.value = selectedTypeId;
      }
    }

    $("typeSelect").addEventListener("change", ()=>{
      selectedTypeId = $("typeSelect").value;
      selectedRound = null;
      updatePickLabel();
      renderRoundButtons();
      updateDetail();
      renderAllCharts();
    });

    function renderSubjectButtons(){
      const wrap = $("subjectButtons");
      wrap.innerHTML = "";
      SUBJECTS.forEach(subj=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "ghost";
        btn.textContent = subj;
        btn.onclick = ()=>{
          selectedSubject = subj;
          selectedRound = null;
          markActiveButtons();
          renderRoundButtons();
          updatePickLabel();
          updateDetail();
          renderAllCharts();
        };
        wrap.appendChild(btn);
      });
      markActiveButtons();
    }

    function markActiveButtons(){
      [...$("subjectButtons").querySelectorAll("button")].forEach(b=>{
        b.classList.toggle("active", b.textContent === selectedSubject);
      });
      [...$("roundButtons").querySelectorAll("button")].forEach(b=>{
        const r = Number(b.dataset.round);
        b.classList.toggle("active", Number.isFinite(r) && r === selectedRound);
      });
    }

    function roundsInScope(){
      if(!selectedTypeId) return [];
      return state.rounds
        .filter(r => r.year === currentYear && r.typeId === selectedTypeId && r.subject === selectedSubject)
        .map(r => Number(r.round))
        .filter(n => Number.isFinite(n))
        .sort((a,b)=>a-b);
    }

    function renderRoundButtons(){
      const wrap = $("roundButtons");
      wrap.innerHTML = "";

      if(!selectedTypeId){
        wrap.innerHTML = `<span class="muted">ì¢…ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜</span>`;
        return;
      }

      const rounds = roundsInScope();

      if(rounds.length === 0){
        wrap.innerHTML = `<span class="muted">íšŒì°¨ ì—†ìŒ(ì˜ê°€ íšŒì°¨ ì¶”ê°€í•˜ë©´ ìƒê¹€)</span>`;
        selectedRound = null;
        markActiveButtons();
        return;
      }

      rounds.forEach(r=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "ghost";
        btn.textContent = `${r}íšŒ`;
        btn.dataset.round = String(r);
        btn.onclick = ()=>{
          selectedRound = r;
          markActiveButtons();
          updatePickLabel();
          updateDetail();
          renderAllCharts();
        };
        wrap.appendChild(btn);
      });

      if(selectedRound == null) selectedRound = rounds[0];
      markActiveButtons();
    }

    function updatePickLabel(){
      const typeName = (state.types[currentYear]||[]).find(t=>t.id===selectedTypeId)?.name ?? "-";
      const rnd = (selectedRound == null) ? "-" : `${selectedRound}íšŒ`;
      $("currentPick").textContent = `${currentYear} / ${typeName} / ${selectedSubject} / ${rnd}`;
      $("currentYearLabel").textContent = currentYear;
    }

    // ==========================================================
    // ë°ì´í„° ì½ê¸°
    // ==========================================================
    function getMyScoreDoc(){
      if(!selectedTypeId || selectedRound==null) return null;
      return state.scores.find(s =>
        s.year===currentYear &&
        s.typeId===selectedTypeId &&
        s.subject===selectedSubject &&
        Number(s.round)===Number(selectedRound)
      ) ?? null;
    }

    function getStatDoc(){
      if(!selectedTypeId || selectedRound==null) return null;
      return state.stats.find(s =>
        s.year===currentYear &&
        s.typeId===selectedTypeId &&
        s.subject===selectedSubject &&
        Number(s.round)===Number(selectedRound)
      ) ?? null;
    }

    function getUnitDocs(){
      if(!selectedTypeId || selectedRound==null) return [];
      return state.units
        .filter(u =>
          u.year===currentYear &&
          u.typeId===selectedTypeId &&
          u.subject===selectedSubject &&
          Number(u.round)===Number(selectedRound)
        )
        .slice()
        .sort((a,b)=>(a.unit||"").localeCompare(b.unit||"", "ko"));
    }

    // ==========================================================
    // ìƒì„¸ + ëŒ€í•™ ì¶”ì²œ
    // ==========================================================
    function updateDetail(){
      const my = getMyScoreDoc();
      $("myScoreLabel").textContent = my ? String(my.score) : "-";
      $("myPctLabel").textContent = (my && my.percentile!=null) ? String(my.percentile) : "-";

      const st = getStatDoc();
      $("avgLabel").textContent = (st && st.avg!=null) ? String(st.avg) : "-";

      const ud = getUnitDocs();
      const tb = $("unitTable");
      tb.innerHTML = "";
      if(ud.length === 0){
        tb.innerHTML = `<tr><td colspan="3" class="muted">ë‹¨ì› ë°ì´í„° ì—†ìŒ(ì˜ê°€ ê´€ë¦¬ì—ì„œ ì¶”ê°€)</td></tr>`;
      }else{
        ud.forEach(x=>{
          tb.innerHTML += `<tr><td>${escapeHtml(x.unit)}</td><td>${x.score ?? "-"}</td><td>${x.maxScore ?? "-"}</td></tr>`;
        });
      }

      renderUniversityCards();
    }

    function renderUniversityCards(){
      const box = $("univCards");
      if(!box) return;

      // ëŒ€í•™ ì¶”ì²œì€ "í•œ ë“±ê¸‰ ì´ìƒ"
      if(!currentUser || gradeHierarchy[currentUser.grade] < gradeHierarchy["í•œ"]){
        box.innerHTML = `<div class="muted">í•œ ë“±ê¸‰ ì´ìƒë¶€í„° ëŒ€í•™ ì¶”ì²œì„ ë³¼ ìˆ˜ ìˆì–´ìš”.</div>`;
        return;
      }

      const my = getMyScoreDoc();
      const myPct = my?.percentile;
      if(myPct == null || !Number.isFinite(Number(myPct))){
        box.innerHTML = `<div class="muted">ë‚´ ë°±ë¶„ìœ„ë¥¼ ì €ì¥í•˜ë©´ ì¶”ì²œì´ ë– ìš”.</div>`;
        return;
      }

      const pct = Number(myPct);

      // í•„ìš” ë°±ë¶„ìœ„ <= ë‚´ ë°±ë¶„ìœ„ë©´ ì§€ì› ê°€ëŠ¥
      const list = (state.univ||[])
        .filter(u => Number(u.minPercentile) <= pct)
        .sort((a,b)=>Number(b.minPercentile)-Number(a.minPercentile))
        .slice(0, 24);

      if(list.length === 0){
        box.innerHTML = `<div class="muted">í˜„ì¬ ë°±ë¶„ìœ„(${pct})ë¡œ ì¶”ì²œí•  ë°ì´í„°ê°€ ì—†ì–´ìš”. (ì˜ê°€ ëŒ€í•™ ë°ì´í„° ì¶”ê°€ í•„ìš”)</div>`;
        return;
      }

      box.innerHTML = list.map(u=>{
        const tag = classifyUniv(pct, u.minPercentile).label;
        return `
          <div class="card">
            <div class="t">${escapeHtml(u.university)} Â· ${escapeHtml(u.major || "")}</div>
            <div class="d">í•„ìš” ë°±ë¶„ìœ„ â‰¥ <b>${u.minPercentile}</b> <span class="pill" style="margin-left:6px">${tag}</span></div>
          </div>
        `;
      }).join("");
    }

    // ==========================================================
    // ì°¨íŠ¸
    // ==========================================================
    function renderChart1(){
      // ì„ íƒí•œ ì¢…ë¥˜+ê³¼ëª©ì˜ íšŒì°¨ë³„ ì ìˆ˜
      const rows = state.scores
        .filter(s => s.year===currentYear && s.typeId===selectedTypeId && s.subject===selectedSubject)
        .map(s => ({ r:Number(s.round), v:Number(s.score) }))
        .filter(x => Number.isFinite(x.r) && Number.isFinite(x.v))
        .sort((a,b)=>a.r-b.r);

      const labels = rows.map(x=>`${x.r}íšŒ`);
      const values = rows.map(x=>x.v);

      c1 = new Chart($("chart1").getContext("2d"),{
        type:"line",
        data:{labels,datasets:[{label:`${selectedSubject} ì ìˆ˜`,data:values,fill:false}]},
        options:{
          responsive:true,
          scales:{
            y:{beginAtZero:true, min:0, max:100}
          }
        }
      });
    }

    function renderChart2(){
      // v4 ë³€ê²½: ì¢…ë¥˜(=type)ë³„ í‰ê·  ë¹„êµ(ë§‰ëŒ€)
      // ì„ íƒ ê³¼ëª© ê¸°ì¤€, í•™ë…„ë„ ë‚´ ëª¨ë“  ì¢…ë¥˜ì— ëŒ€í•´ "ê·¸ ì¢…ë¥˜ì˜ íšŒì°¨ë“¤ ì ìˆ˜ í‰ê· "ì„ ë§‰ëŒ€ë¡œ í‘œì‹œ
      const types = (state.types[currentYear] || []);
      const typeNameById = new Map(types.map(t=>[t.id, t.name]));

      // typeId -> [scores...]
      const bucket = new Map();
      for(const s of state.scores){
        if(s.year !== currentYear) continue;
        if(s.subject !== selectedSubject) continue;
        const v = Number(s.score);
        if(!Number.isFinite(v)) continue;
        if(!bucket.has(s.typeId)) bucket.set(s.typeId, []);
        bucket.get(s.typeId).push(v);
      }

      const labels = [];
      const values = [];

      for(const t of types){
        const arr = bucket.get(t.id) || [];
        if(arr.length === 0) continue; // ë°ì´í„° ì—†ëŠ” ì¢…ë¥˜ëŠ” ìˆ¨ê¹€
        const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
        labels.push(typeNameById.get(t.id) || "?");
        values.push(Math.round(avg*10)/10);
      }

      if(labels.length === 0){
        // ê·¸ë˜í”„ê°€ ë¹„ì–´ë„ ì°¨íŠ¸ ìƒì„±ì€ í•˜ë˜ ë¹ˆ ë°ì´í„°
      }

      c2 = new Chart($("chart2").getContext("2d"),{
        type:"bar",
        data:{labels,datasets:[{label:`ì¢…ë¥˜ë³„ ${selectedSubject} í‰ê· `,data:values}]},
        options:{
          responsive:true,
          scales:{ y:{beginAtZero:true, min:0, max:100} }
        }
      });
    }

    function renderChart3(){
      const my = getMyScoreDoc();
      const st = getStatDoc();
      const myScore = my ? Number(my.score) : null;
      const avg = (st && st.avg!=null) ? Number(st.avg) : null;

      const labels = [];
      const values = [];
      if(myScore!=null && Number.isFinite(myScore)){ labels.push("ë‚´ ì ìˆ˜"); values.push(myScore); }
      if(avg!=null && Number.isFinite(avg)){ labels.push("í‰ê· "); values.push(avg); }

      const cuts = [];
      if(st){
        for(let i=1;i<=9;i++){
          const v = st["cut"+i];
          if(v!=null && v!=="" && Number.isFinite(Number(v))) cuts.push({grade:i, value:Number(v)});
        }
      }

      c3 = new Chart($("chart3").getContext("2d"),{
        type:"bar",
        data:{labels,datasets:[{label:`${selectedSubject} ë¹„êµ`,data:values}]},
        options:{responsive:true,scales:{y:{beginAtZero:true, min:0, max:100}}},
        plugins:[{
          id:"cutLines",
          afterDatasetsDraw(chart){
            const {ctx,chartArea:{left,right},scales:{y}}=chart;
            ctx.save();
            ctx.setLineDash([6,6]);
            ctx.lineWidth=1;
            cuts.forEach(c=>{
              const yPos = y.getPixelForValue(c.value);
              ctx.beginPath(); ctx.moveTo(left,yPos); ctx.lineTo(right,yPos); ctx.stroke();
              ctx.setLineDash([]);
              ctx.fillStyle="#374151";
              ctx.font="12px system-ui";
              ctx.fillText(`${c.grade}ì»· ${c.value}`, left+6, yPos-4);
              ctx.setLineDash([6,6]);
            });
            ctx.restore();
          }
        }]
      });
    }

    function renderChart4(){
      const ud = getUnitDocs();
      const labels = ud.map(x=>x.unit);
      const values = ud.map(x=>Number(x.score));
      c4 = new Chart($("chart4").getContext("2d"),{
        type:"bar",
        data:{labels,datasets:[{label:`ë‹¨ì›ë³„ ${selectedSubject}`,data:values}]},
        options:{responsive:true,scales:{y:{beginAtZero:true, min:0, max:100}}}
      });
    }

    function renderAllCharts(){
      destroyCharts();
      if(!selectedTypeId) return;
      renderChart1();
      renderChart2();
      renderChart3();
      renderChart4();
    }

    // ==========================================================
    // ì˜ ì „ìš©: íšŒì°¨ ì¶”ê°€/ì‚­ì œ
    // ==========================================================
    $("addRoundBtn").addEventListener("click", async ()=>{
      if(!currentUser || currentUser.grade !== "ì˜") return;
      if(!selectedTypeId) return alert("ì¢…ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");
      const raw = $("newRoundInput").value.trim();
      const r = Number(raw);
      if(!Number.isFinite(r) || r <= 0) return alert("íšŒì°¨ëŠ” 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");
      const exists = state.rounds.some(x =>
        x.year===currentYear && x.typeId===selectedTypeId && x.subject===selectedSubject && Number(x.round)===r
      );
      if(exists) return alert("ì´ë¯¸ ìˆëŠ” íšŒì°¨ì•¼.");

      state.rounds.push({ id: uid(), year: currentYear, typeId: selectedTypeId, subject: selectedSubject, round: r, createdAt: Date.now() });
      await saveStateToServer();
      $("newRoundInput").value = "";

      renderRoundButtons();
      updatePickLabel();
      updateDetail();
      renderAllCharts();
    });

    $("deleteRoundBtn").addEventListener("click", async ()=>{
      if(!currentUser || currentUser.grade !== "ì˜") return;
      if(!selectedTypeId || selectedRound==null) return alert("ì¢…ë¥˜/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");

      const ok = confirm(`ì„ íƒ íšŒì°¨(${selectedRound}íšŒ)ë¥¼ ì‚­ì œí• ê¹Œ?\n- í•´ë‹¹ íšŒì°¨ì˜ ì ìˆ˜/í†µê³„/ë‹¨ì› ë°ì´í„°ë„ ê°™ì´ ì‚­ì œë©ë‹ˆë‹¤.`);
      if(!ok) return;

      const y = currentYear, t = selectedTypeId, sub = selectedSubject, r = Number(selectedRound);

      state.rounds = state.rounds.filter(x => !(x.year===y && x.typeId===t && x.subject===sub && Number(x.round)===r));
      state.scores = state.scores.filter(x => !(x.year===y && x.typeId===t && x.subject===sub && Number(x.round)===r));
      state.stats  = state.stats .filter(x => !(x.year===y && x.typeId===t && x.subject===sub && Number(x.round)===r));
      state.units  = state.units .filter(x => !(x.year===y && x.typeId===t && x.subject===sub && Number(x.round)===r));

      await saveStateToServer();

      selectedRound = null;
      renderRoundButtons();
      updatePickLabel();
      updateDetail();
      renderAllCharts();
    });

    // ==========================================================
    // ì˜ ì „ìš©: ì ìˆ˜ ì €ì¥/ì—…ë°ì´íŠ¸
    // ==========================================================
    $("saveScoreBtn").addEventListener("click", async ()=>{
      if(!currentUser || currentUser.grade !== "ì˜") return;

      if(!selectedTypeId || selectedRound==null){
        alert("ì¢…ë¥˜/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");
        return;
      }

      const score = parseInt($("scoreInput").value,10);
      if(Number.isNaN(score)) return alert("ì ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");

      const pctRaw = $("percentileInput").value.trim();
      const percentile = (pctRaw==="") ? null : parseInt(pctRaw,10);

      // íšŒì°¨ê°€ ì•„ì§ roundsì— ì—†ìœ¼ë©´ ìë™ ìƒì„±
      const r = Number(selectedRound);
      const hasRound = state.rounds.some(x => x.year===currentYear && x.typeId===selectedTypeId && x.subject===selectedSubject && Number(x.round)===r);
      if(!hasRound){
        state.rounds.push({ id: uid(), year: currentYear, typeId: selectedTypeId, subject: selectedSubject, round: r, createdAt: Date.now() });
      }

      const existing = getMyScoreDoc();
      if(existing){
        existing.score = score;
        existing.percentile = percentile;
        existing.updatedAt = Date.now();
      }else{
        state.scores.push({
          id: uid(),
          year: currentYear,
          typeId: selectedTypeId,
          subject: selectedSubject,
          round: r,
          score,
          percentile,
          updatedAt: Date.now()
        });
      }

      await saveStateToServer();

      $("scoreInput").value="";
      $("percentileInput").value="";

      renderRoundButtons();
      updatePickLabel();
      updateDetail();
      renderAllCharts();

      if(currentUser.grade==="ì˜") renderManageAll();
    });

    // ==========================================================
    // ê´€ë¦¬(ì˜ ì „ìš©)
    // ==========================================================
    $("manageTab").addEventListener("click", ()=>{
      if(!currentUser || currentUser.grade!=="ì˜") return;
      $("manageSection").classList.toggle("hidden");
      renderManageAll();
      $("manageSection").scrollIntoView({behavior:"smooth", block:"start"});
    });

    function renderManageAll(){
      renderTypeList();
      renderUserList();
      renderLogs();
    }

    function renderTypeList(){
      const wrap = $("typeList");
      const list = state.types[currentYear] || [];
      if(list.length===0){ wrap.textContent="ë“±ë¡ëœ ì¢…ë¥˜ ì—†ìŒ"; return; }

      wrap.innerHTML = list.map(t=>`
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0;">
          <div>â€¢ <b>${escapeHtml(t.name)}</b></div>
          <button class="danger" type="button" data-deltype="${t.id}">ì‚­ì œ</button>
        </div>
      `).join("");

      wrap.querySelectorAll("button[data-deltype]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-deltype");
          // ì´ ì¢…ë¥˜ë¡œ ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚­ì œ ë§‰ê¸°
          const hasData =
            state.scores.some(s=>s.year===currentYear && s.typeId===id) ||
            state.stats.some(s=>s.year===currentYear && s.typeId===id) ||
            state.units.some(s=>s.year===currentYear && s.typeId===id) ||
            state.rounds.some(r=>r.year===currentYear && r.typeId===id);
          if(hasData) return alert("ì´ ì¢…ë¥˜ ë°ì´í„°ê°€ ìˆì–´ì„œ ì‚­ì œ ë¶ˆê°€(ë°ì´í„° ë¨¼ì € ì‚­ì œí•´ì•¼ í•¨)");

          state.types[currentYear] = (state.types[currentYear]||[]).filter(x=>x.id!==id);
          await saveStateToServer();
          renderTypeSelect();
          renderTypeList();
        });
      });
    }

    $("addTypeBtn").addEventListener("click", async ()=>{
      if(!currentUser || currentUser.grade!=="ì˜") return;
      const name = $("newTypeInput").value.trim();
      if(!name) return alert("ì¢…ë¥˜ ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
      const list = state.types[currentYear] || [];
      if(list.some(t=>t.name===name)) return alert("ì´ë¯¸ ìˆëŠ” ì¢…ë¥˜ì•¼.");
      list.push({ id: uid(), name, createdAt: Date.now() });
      state.types[currentYear] = list;
      await saveStateToServer();
      $("newTypeInput").value="";
      renderTypeSelect();
      renderTypeList();
    });

    async function addUser(){
      if(!currentUser || currentUser.grade!=="ì˜") return;

      const name = $("newUserName").value.trim();
      const pw = $("newPw").value.trim();
      const grade = $("newGrade").value;

      if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
      if(!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");

      const pwHash = await sha256(pw);
      if(state.users.some(u=>u.pwHash===pwHash)) return alert("ì´ë¯¸ ê°™ì€ ë¹„ë°€ë²ˆí˜¸ê°€ ë“±ë¡ë˜ì–´ ìˆì–´.");

      state.users.push({ id: uid(), name, grade, pwHash, createdAt: Date.now() });
      await saveStateToServer();

      $("newUserName").value="";
      $("newPw").value="";
      renderUserList();
    }

    $("addUserBtn").addEventListener("click", ()=>{ addUser(); });

    function renderUserList(){
      const wrap = $("userList");
      wrap.innerHTML = "";
      state.users.forEach(u=>{
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="t">${escapeHtml(u.name)}</div>
          <div class="d">ë“±ê¸‰: <b>${escapeHtml(u.grade)}</b></div>
          <button class="danger" type="button" data-deluser="${u.id}" style="margin-top:8px">ì‚­ì œ</button>
        `;
        wrap.appendChild(div);
      });

      wrap.querySelectorAll("button[data-deluser]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-deluser");
          if(state.users.length===1) return alert("ìµœì†Œ 1ëª…(ê´€ë¦¬ì)ì€ ë‚¨ê²¨ì•¼ í•´.");
          state.users = state.users.filter(u=>u.id!==id);
          await saveStateToServer();
          renderUserList();
        });
      });
    }

    function renderLogs(){
      const box = $("loginRecords");
      if(!state.logs || state.logs.length===0){ box.textContent="ê¸°ë¡ ì—†ìŒ"; return; }
      box.innerHTML = state.logs.slice().reverse().map(l=>`â€¢ [${escapeHtml(l.time)}] ${escapeHtml(l.name)} (${escapeHtml(l.grade)})`).join("<br/>");
    }

    $("clearLogsBtn").addEventListener("click", async ()=>{
      if(!currentUser || currentUser.grade!=="ì˜") return;
      state.logs = [];
      await saveStateToServer();
      renderLogs();
    });

    // í†µê³„ ì €ì¥/ì—…ë°ì´íŠ¸
    $("saveStatsBtn").addEventListener("click", async ()=>{
      if(!currentUser || currentUser.grade!=="ì˜") return;
      if(!selectedTypeId || selectedRound==null) return alert("ì¢…ë¥˜/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");

      const avgRaw = $("statAvg").value.trim();
      const avg = (avgRaw==="") ? null : Number(avgRaw);

      const data = {
        id: uid(),
        year: currentYear,
        typeId: selectedTypeId,
        subject: selectedSubject,
        round: Number(selectedRound),
        avg: (avg==null || Number.isNaN(avg)) ? null : avg,
        updatedAt: Date.now()
      };

      for(let i=1;i<=9;i++){
        const v = $("cut"+i).value.trim();
        data["cut"+i] = (v==="") ? null : Number(v);
        if(Number.isNaN(data["cut"+i])) data["cut"+i]=null;
      }

      const idx = state.stats.findIndex(s =>
        s.year===data.year && s.typeId===data.typeId && s.subject===data.subject && Number(s.round)===Number(data.round)
      );
      if(idx >= 0){
        // id ìœ ì§€
        const keepId = state.stats[idx].id;
        state.stats[idx] = { ...data, id: keepId };
      }else{
        state.stats.push(data);
      }

      await saveStateToServer();
      updateDetail();
      renderAllCharts();
    });

    // ë‹¨ì› ì¶”ê°€
    $("addUnitBtn").addEventListener("click", async ()=>{
      if(!currentUser || currentUser.grade!=="ì˜") return;
      if(!selectedTypeId || selectedRound==null) return alert("ì¢…ë¥˜/íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");

      const unit = $("unitName").value.trim();
      const scoreRaw = $("unitScore").value.trim();
      const maxRaw = $("unitMax").value.trim();

      if(!unit) return alert("ë‹¨ì›ëª…ì„ ì…ë ¥í•´ì¤˜.");
      const score = Number(scoreRaw);
      if(!Number.isFinite(score)) return alert("ë‹¨ì› ì ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì¤˜.");

      const maxScore = (maxRaw==="") ? null : Number(maxRaw);

      state.units.push({
        id: uid(),
        year: currentYear,
        typeId: selectedTypeId,
        subject: selectedSubject,
        round: Number(selectedRound),
        unit,
        score,
        maxScore: (maxScore!=null && Number.isFinite(maxScore)) ? maxScore : null,
        updatedAt: Date.now()
      });

      await saveStateToServer();

      $("unitName").value="";
      $("unitScore").value="";
      $("unitMax").value="";
      updateDetail();
      renderAllCharts();
    });

    // ëŒ€í•™ ë°ì´í„° ì €ì¥/ì‚­ì œ
    $("importUnivBtn").addEventListener("click", async ()=>{
      if(!currentUser || currentUser.grade!=="ì˜") return;
      const text = $("univPaste").value.trim();
      if(!text) return alert("ë¶™ì—¬ë„£ì„ ë°ì´í„°ê°€ ì—†ì–´.");

      const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);

      for(const line of lines){
        const parts = line.split(",").map(x=>x.trim());
        if(parts.length < 2) continue;
        const minPercentile = Number(parts[0]);
        const university = parts[1] || "";
        const major = parts[2] || "";
        if(!Number.isFinite(minPercentile) || !university || !major) continue;

        state.univ.push({ id: uid(), minPercentile, university, major, createdAt: Date.now() });
      }

      await saveStateToServer();
      $("univPaste").value="";
      alert("ëŒ€í•™ ë°ì´í„° ì €ì¥ ì™„ë£Œ!");
      renderUniversityCards();
    });

    $("clearUnivBtn").addEventListener("click", async ()=>{
      if(!currentUser || currentUser.grade!=="ì˜") return;
      state.univ = [];
      await saveStateToServer();
      renderUniversityCards();
    });

    // ì „ì²´ ì´ˆê¸°í™”(ì„œë²„)
    $("resetAllBtn").addEventListener("click", async ()=>{
      if(!currentUser || currentUser.grade!=="ì˜") return;
      if(!confirm("ì§„ì§œë¡œ ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) return;
      state = defaultState();
      seedDefaultsIfEmpty();
      await saveStateToServer();
      currentUser = null;
      destroyCharts();
      alert("ì‚­ì œ ì™„ë£Œ. ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
      boot();
    });

    // ==========================================================
    // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ/ìµœì´ˆ ê´€ë¦¬ì ìƒì„±
    // ==========================================================
    $("logoutBtn").addEventListener("click", ()=>{
      currentUser = null;
      destroyCharts();
      boot();
    });

    $("loginBtn").addEventListener("click", async ()=>{
      try{
        const pw = $("pwInput").value.trim();
        if(!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");
        const user = await loginWithPassword(pw);
        if(!user) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");

        currentUser = user;
        await addLog(user.name, user.grade);
        afterLogin();
      }catch(e){
        console.error(e);
        alert("ë¡œê·¸ì¸ ì˜¤ë¥˜ê°€ ë‚¬ì–´. (ë¸Œë¼ìš°ì € ì½˜ì†” F12 í™•ì¸)");
      }
    });

    $("setupBtn").addEventListener("click", async ()=>{
      const name = $("setupName").value.trim();
      const pw = $("setupPw").value.trim();
      if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.");
      if(!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.");

      const pwHash = await sha256(pw);

      // ìµœì´ˆ 1ëª… ì˜ ìƒì„±
      state.users.push({ id: uid(), name, grade: "ì˜", pwHash, createdAt: Date.now() });

      // ê¸°ë³¸ ì¢…ë¥˜/ëŒ€í•™ seed
      seedDefaultsIfEmpty();

      await saveStateToServer();
      alert("ê´€ë¦¬ì ìƒì„± ì™„ë£Œ! ì´ì œ ë¡œê·¸ì¸ í™”ë©´ì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì¤˜.");
      boot();
    });

    // ==========================================================
    // ì´ˆê¸° ì‹¤í–‰: ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê³  boot()
    // ==========================================================
    (async ()=>{
      await loadStateFromServer();
      boot();
    })();
  </script>
</body>
</html>
